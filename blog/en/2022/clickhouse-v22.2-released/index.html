










    



    



    



    
    






    
        
    
    <!DOCTYPE html>
<html lang="en" >
<head>
    
<meta charset="utf-8" />
<META http-equiv="Content-type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>ClickHouse 22.2 Released</title>

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/docs/images/logo-180x180.png" />

<meta property="og:title" content="ClickHouse 22.2 Released"/>
<meta property="og:description" content="We prepared a new ClickHouse release 22.2, so it's nice if you have tried it on 2022-02-22. If not, you can try it today" />
<meta property="og:type" content="article" />

<meta property="og:image" content="https://blog-images.clickhouse.com/en/2022/clickhouse-v22-2/featured.jpg" />

<meta property="og:url" content="https://clickhouse.com/blog/en/2022/clickhouse-v22.2-released/"/>
<link rel="canonical" href="https://clickhouse.com/blog/en/2022/clickhouse-v22.2-released/" />

<link rel="search" href="/opensearch.xml" title="ClickHouse" type="application/opensearchdescription+xml" />

<script type="application/ld+json">[{
"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "ClickHouse 22.2 Released",
"mainEntityOfPage": "https://clickhouse.com/blog/en/2022/clickhouse-v22.2-released/",

"datePublished": "2022-02-23",
"dateModified": "2022-02-23",

"image": "https://blog-images.clickhouse.com/en/2022/clickhouse-v22-2/featured.jpg",
"author": {
  "@type": "Project",
  "name": "ClickHouse"
},
"publisher": {
  "@type": "Organization",
  "name": "ClickHouse, Inc.",
  "logo": {
    "@type": "ImageObject",
    "url": "https://clickhouse.com/images/logo-400x240.png",
    "width": 400,
    "height": 240
  }
}}]</script>


<meta name="description" content="We prepared a new ClickHouse release 22.2, so it's nice if you have tried it on 2022-02-22. If not, you can try it today" />

<meta name="keywords"
      content="company, community" />








<link rel="alternate" type="application/rss+xml" href="https://clickhouse.com/blog/en/rss.xml" />

    
    <link href="/docs/css/base.css?css_digest" media="all" rel="stylesheet" />


</head>
<body dir="ltr" class="blog">
    
    
    
    <div class="page">
        
    
        <nav id="top-nav" class="navbar navbar-expand-md mb-3">
    <div class="container justify-content-between">
        <a class="d-block navbar-brand mr-3 text-reset" href="/">
            <img id="docs-logo-icon" src="/images/logo.svg" alt="ClickHouse logo" title="ClickHouse logo"/>
        </a>
        <div class="w-100 navbar-text text-left d-none d-md-block">
            <h2 class="display-4 text-reset m-0 p-0 d-inline">
                <a href="/blog/en/" class="text-reset text-decoration-none">
                    ClickHouse Blog
                </a>
            </h2>
        </div>

        <div class="d-none d-md-block">
            <ul class="navbar-nav ml-auto mt-2 mt-lg-0 justify-content-end">
                <li class="nav-item">
                     <a class="nav-link text-reset"
                        href="https://github.com/ClickHouse/ClickHouse/tree/master/website/blog"
                        rel="external nofollow noreferral" target="_blank">
                        New&nbsp;post
                     </a>
                </li>
                <li class="nav-item">
                     <a class="nav-link text-reset" href="/docs/en/">
                        Documentation
                     </a>
                </li>
                <li class="nav-item">
                     <a class="nav-link text-reset"
                        href="https://github.com/ClickHouse/ClickHouse"
                        rel="external nofollow noreferrer" target="_blank">
                        GitHub
                     </a>
                </li>
                <li id="languages-wrapper" class="nav-item dropdown mr-3">
                    <div id="languages-dropdown">
                        <a class="nav-link dropdown-toggle d-inline-block text-reset" href="#" id="lang-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img src="/images/flags/en.svg" alt="English" title="English" width="60" class="d-inline-block" />
                        </a>
                        <div class="dropdown-menu" aria-labelledby="lang-dropdown">
                            
                            <a class="dropdown-item text-reset disabled"
                               href="/blog/en/">
                                <img src="/images/flags/en.svg" alt="" title="" width="32" class="d-inline-block mr-2" />
                                English
                            </a>
                            
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>
        <div class="container">
            <div class="row">
                <div id="content-wrapper" class="col">
    
    <div id="content">
        <header class="text-center">
            
                <img class="img-fluid mb-3" src="https://blog-images.clickhouse.com/en/2022/clickhouse-v22-2/featured.jpg" alt="ClickHouse 22.2 Released" title="ClickHouse 22.2 Released" />
            
            <h1 class="display-2 mt-3 mb-5">ClickHouse 22.2 Released</h1>
        </header>

        <div class="row">
            <article class="col-md-10 offset-1">
                <p>We prepared a new ClickHouse release 22.2, so it's nice if you have tried it on 2022-02-22. If not, you can try it today. This latest release includes 2,140 new commits from 118 contributors, including 41 new contributors:</p>
<blockquote>
<p>Aaron Katz, Andre Marianiello, Andrew, Andrii Buriachevskyi, Brian Hunter, CoolT2, Federico Rodriguez, Filippov Denis, Gaurav Kumar, Geoff Genz, HarryLeeIBM, Heena Bansal, ILya Limarenko, Igor Nikonov, IlyaTsoi, Jake Liu, JaySon-Huang, Lemore, Leonid Krylov, Michail Safronov, Mikhail Fursov, Nikita, RogerYK, Roy Bellingan, Saad Ur Rahman, W, Yakov Olkhovskiy, alexeypavlenko, cnmade, grantovsky, hanqf-git, liuneng1994, mlkui, s-kat, tesw yew isal, vahid-sohrabloo, yakov-olkhovskiy, zhifeng, zkun, zxealous, 박동철.</p>
</blockquote>
<p>Let me tell you what is most interesting in 22.2...</p>
<h2 id="projections-are-production-ready">Projections are production ready<a class="headerlink" href="#projections-are-production-ready" title="Permanent link"> </a></h2>
<p>Projections allow you to have multiple data representations in the same table. For example, you can have data aggregations along with the raw data. There are no restrictions on which aggregate functions can be used - you can have count distinct, quantiles, or whatever you want. You can have data in multiple different sorting orders. ClickHouse will automatically select the most suitable projection for your query, so the query will be automatically optimized.</p>
<p>Projections are somewhat similar to Materialized Views, which also allow you to have incremental aggregation and multiple sorting orders. But unlike Materialized Views, projections are updated atomically and consistently with the main table. The data for projections is being stored in the same "data parts" of the table and is being merged in the same way as the main data.</p>
<p>The feature was developed by <strong>Amos Bird</strong>, a prominent ClickHouse contributor. The <a href="https://github.com/ClickHouse/ClickHouse/pull/20202" rel="external nofollow noreferrer" target="_blank">prototype</a> has been available since Feb 2021, it has been merged in the main codebase by <strong>Nikolai Kochetov</strong> in May 2021 under experimental flag, and after 21 follow-up pull requests we ensured that it passed the full set of test suites and enabled it by default.</p>
<p>Read an example of how to optimize queries with projections <a href="https://clickhouse.com/docs/en/getting-started/example-datasets/uk-price-paid/#speedup-with-projections" target="_blank">in our docs</a>.</p>
<h2 id="control-of-file-creation-and-rewriting-on-data-export">Control of file creation and rewriting on data export<a class="headerlink" href="#control-of-file-creation-and-rewriting-on-data-export" title="Permanent link"> </a></h2>
<p>When you export your data with an <code class="syntax">INSERT INTO TABLE FUNCTION</code> statement into <code class="syntax">file</code>, <code class="syntax">s3</code> or <code class="syntax">hdfs</code> and the target file already exists, you can now control how to deal with it: you can append new data into the file if it is possible, rewrite it with new data, or create another file with a similar name like 'data.1.parquet.gz'. </p>
<p>Some storage systems like <code class="syntax">s3</code> and some formats like <code class="syntax">Parquet</code> don't support data appending. In previous ClickHouse versions, if you insert multiple times into a file with Parquet data format, you will end up with a file that is not recognized by other systems. Now you can choose between throwing exceptions on subsequent inserts or creating more files.</p>
<p>So, new settings were introduced: <code class="syntax">s3_truncate_on_insert</code>, <code class="syntax">s3_create_new_file_on_insert</code>, <code class="syntax">hdfs_truncate_on_insert</code>, <code class="syntax">hdfs_create_new_file_on_insert</code>, <code class="syntax">engine_file_allow_create_multiple_files</code>.</p>
<p>This feature <a href="https://github.com/ClickHouse/ClickHouse/pull/33302" rel="external nofollow noreferrer" target="_blank">was developed</a> by <strong>Pavel Kruglov</strong>.</p>
<h2 id="custom-deduplication-token">Custom deduplication token<a class="headerlink" href="#custom-deduplication-token" title="Permanent link"> </a></h2>
<p><code class="syntax">ReplicatedMergeTree</code> and <code class="syntax">MergeTree</code> types of tables implement block-level deduplication. When a block of data is inserted, its cryptographic hash is calculated and if the same block was already inserted before, then the duplicate is skipped and the insert query succeeds. This makes it possible to implement exactly-once semantics for inserts.</p>
<p>In ClickHouse version 22.2 you can provide your own deduplication token instead of an automatically calculated hash. This makes sense if you already have batch identifiers from some other system and you want to reuse them. It also makes sense when blocks can be identical but they should actually be inserted multiple times. Or the opposite - when blocks contain some random data and you want to deduplicate only by significant columns.</p>
<p>This is implemented by adding the setting <code class="syntax">insert_deduplication_token</code>. The feature was contributed by <strong>Igor Nikonov</strong>. </p>
<h2 id="default-keyword-for-insert">DEFAULT keyword for INSERT<a class="headerlink" href="#default-keyword-for-insert" title="Permanent link"> </a></h2>
<p>A small addition for SQL compatibility - now we allow using the <code class="syntax">DEFAULT</code> keyword instead of a value in <code class="syntax">INSERT INTO ... VALUES</code> statement. It looks like this: </p>
<p><code class="syntax">INSERT INTO test VALUES (1, 'Hello', DEFAULT)</code></p>
<p>Thanks to <strong>Andrii Buriachevskyi</strong> for this feature. </p>
<h2 id="ephemeral-columns">EPHEMERAL columns<a class="headerlink" href="#ephemeral-columns" title="Permanent link"> </a></h2>
<p>A column in a table can have a <code class="syntax">DEFAULT</code> expression like <code class="syntax">c INT DEFAULT a + b</code>. In ClickHouse you can also use <code class="syntax">MATERIALIZED</code> instead of <code class="syntax">DEFAULT</code> if you want the column to be always calculated with the provided expression instead of allowing a user to insert data. And you can use <code class="syntax">ALIAS</code> if you don't want the column to be stored at all but instead to be calculated on the fly if referenced.</p>
<p>Since version 22.2 a new type of column is added: <code class="syntax">EPHEMERAL</code> column. The user can insert data into this column but the column is not stored in a table, it's ephemeral. The purpose of this column is to provide data to calculate other columns that can reference it with <code class="syntax">DEFAULT</code> or <code class="syntax">MATERIALIZED</code> expressions.</p>
<p>This feature was made by <strong>Yakov Olkhovskiy</strong>.</p>
<h2 id="improvements-for-multi-disk-configuration">Improvements for multi-disk configuration<a class="headerlink" href="#improvements-for-multi-disk-configuration" title="Permanent link"> </a></h2>
<p>You can configure multiple disks to store ClickHouse data instead of managing RAID and ClickHouse will automatically manage the data placement.</p>
<p>Since version 22.2 ClickHouse can automatically repair broken disks without server restart by downloading the missing parts from replicas and placing them on the healthy disks.</p>
<p>This feature was implemented by <strong>Amos Bird</strong> and is already being used for more than 1.5 years in production at Kuaishou.</p>
<p>Another improvement is the option to specify TTL MOVE TO DISK/VOLUME <strong>IF EXISTS</strong>. It allows replicas with non-uniform disk configuration and to have one replica to move old data to cold storage while another replica has all the data on hot storage. Data will be moved only on replicas that have the specified disk or volume, hence <em>if exists</em>. This was developed by <strong>Anton Popov</strong>.</p>
<h2 id="flexible-memory-limits">Flexible memory limits<a class="headerlink" href="#flexible-memory-limits" title="Permanent link"> </a></h2>
<p>We split per-query and per-user memory limits into a pair of hard and soft limits. The settings <code class="syntax">max_memory_usage</code> and <code class="syntax">max_memory_usage_for_user</code> act as hard limits. When memory consumption is approaching the hard limit, an exception will be thrown. Two other settings: <code class="syntax">max_guaranteed_memory_usage</code> and <code class="syntax">max_guaranteed_memory_usage_for_user</code> act as soft limits.</p>
<p>A query will be allowed to use more memory than a soft limit if there is available memory. But if there will be memory shortage (relative to the per-user hard limit or total per-server memory consumption), we calculate the "overcommit ratio" - how much more memory every query is consuming relative to the soft limit - and we will kill the most overcommitted query to let other queries run.</p>
<p>In short, your query will not be limited to a few gigabytes of RAM if you have hundreds of gigabytes available.</p>
<p>This experimental feature was implemented by <strong>Dmitry Novik</strong> and is continuing to be developed.</p>
<h2 id="shell-style-comments-in-sql">Shell-style comments in SQL<a class="headerlink" href="#shell-style-comments-in-sql" title="Permanent link"> </a></h2>
<p>Now we allow comments starting with <code class="syntax">#</code> or <code class="syntax">#!</code>, similar to MySQL. The variant with <code class="syntax">#!</code> allows using shell scripts with "shebang" interpreted by <code class="syntax">clickhouse-local</code>.</p>
<p>This feature was contributed by <strong>Aaron Katz</strong>. Very nice.  </p>
<h2 id="and-many-more">And many more...<a class="headerlink" href="#and-many-more" title="Permanent link"> </a></h2>
<p>Maxim Kita, Danila Kutenin, Anton Popov, zhanglistar, Federico Rodriguez, Raúl Marín, Amos Bird and Alexey Milovidov have contributed a ton of performance optimizations for this release. We are obsessed with high performance, as usual. :)</p>
<p>Read the <a href="https://github.com/ClickHouse/ClickHouse/blob/master/CHANGELOG.md" rel="external nofollow noreferrer" target="_blank">full changelog</a> for the 22.2 release and follow <a href="https://github.com/ClickHouse/ClickHouse/issues/32513" rel="external nofollow noreferrer" target="_blank">the roadmap</a>.</p>
            </article>
            <section class="d-none d-md-block col-md-1 mh-100">
                <div class="sticky-top pt-2">
                    <a class="d-block mb-2" href="https://twitter.com/intent/tweet?url=ClickHouse%2022.2%20Released+https%3A//clickhouse.com/blog/en/2022/clickhouse-v22.2-released/"
                       rel="external nofollow noreferrer" target="_blank">
                        <img src="/images/index/twitter.svg"
                             alt="Share on Twitter" title="Share on Twitter" class="social-icon rounded-circle img-fluid w-100 p-1" />
                    </a>
                    <a class="d-block mb-2" href="https://news.ycombinator.com/submitlink?t=ClickHouse%2022.2%20Released&u=https%3A//clickhouse.com/blog/en/2022/clickhouse-v22.2-released/"
                       rel="external nofollow noreferrer" target="_blank">
                        <img src="/images/index/hackernews.svg"
                             alt="Share on HackerNews" title="Share on Hacker News" class="rounded-circle img-fluid w-100 p-1" />
                    </a>
                    <a class="d-block mb-2" href="http://www.reddit.com/submit?title=ClickHouse%2022.2%20Released&url=https%3A//clickhouse.com/blog/en/2022/clickhouse-v22.2-released/"
                       rel="external nofollow noreferrer" target="_blank">
                        <img src="/images/index/reddit.svg"
                             alt="Share on Reddit" title="Share on Reddit" class="invert-dark rounded-circle img-fluid w-100 p-1" />
                    </a>
                </div>
            </section>
        </div>

        
        <section class="col-md-10 offset-md-1 my-5">Author: <em>Alexey Milovidov</em></section>
        

        <section class="col-md-10 offset-md-1 my-5">
            <span title="Published date" class="d-inline-block bg-dark text-white p-2 mr-2">2022-02-23</span>
            
                
                    <div class="tag d-inline-block bg-light p-2 mr-2">
                        company
                    </div>
                
                    <div class="tag d-inline-block bg-light p-2 mr-2">
                        community
                    </div>
                
            
        </section>


    </div>
    
</div>
            </div>
        </div>
        
        <div class="container">
    <div class="row">
        <div class="col">
            <div id="content-footer" class="text-muted pt-3 mb-5">
                <div class="float-md-right">©2016–2022 ClickHouse, Inc.</div>
            </div>
        </div>
    </div>
</div>
    

    
        
        <script async type="text/javascript" src="/docs/js/base.js?js_digest"></script>



<noscript>
    <div><img src="https://mc.yandex.ru/watch/18343495" alt="Yandex"/></div>
</noscript>
    </div>
</body>
</html>