"use strict";(self.webpackChunkclickhouse=self.webpackChunkclickhouse||[]).push([[98985],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),c=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(i.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,i=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),m=r,g=d["".concat(i,".").concat(m)]||d[m]||u[m]||l;return n?a.createElement(g,o(o({ref:t},p),{},{components:n})):a.createElement(g,o({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,o=new Array(l);o[0]=d;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<l;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},87858:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return i},default:function(){return m},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return u}});var a=n(87462),r=n(63366),l=(n(67294),n(3905)),o=["components"],s={sidebar_label:"PostgreSQL Database Engine",sidebar_position:20,keywords:["clickhouse","postgres","postgresql","connect","integrate"]},i="Connecting ClickHouse to PostgreSQL using the MaterializedPostgreSQL database engine",c={unversionedId:"integrations/postgresql/postgres-with-clickhouse-database-engine",id:"integrations/postgresql/postgres-with-clickhouse-database-engine",title:"Connecting ClickHouse to PostgreSQL using the MaterializedPostgreSQL database engine",description:"The PostgreSQL database engine uses the PostgreSQL replication features to create a replica of the database with all or a subset of schemas and tables.",source:"@site/docs/integrations/postgresql/postgres-with-clickhouse-database-engine.md",sourceDirName:"integrations/postgresql",slug:"/integrations/postgresql/postgres-with-clickhouse-database-engine",permalink:"/docs/integrations/postgresql/postgres-with-clickhouse-database-engine",tags:[],version:"current",sidebarPosition:20,frontMatter:{sidebar_label:"PostgreSQL Database Engine",sidebar_position:20,keywords:["clickhouse","postgres","postgresql","connect","integrate"]},sidebar:"tutorialSidebar",previous:{title:"Connect PostgreSQL and ClickHouse",permalink:"/docs/integrations/postgresql/postgres-with-clickhouse"},next:{title:"S3",permalink:"/docs/integrations/s3"}},p={},u=[{value:"1. In PostgreSQL",id:"1-in-postgresql",level:2},{value:"2. In ClickHouse",id:"2-in-clickhouse",level:2},{value:"3. Test basic replication",id:"3-test-basic-replication",level:2},{value:"4. Summary",id:"4-summary",level:2}],d={toc:u};function m(e){var t=e.components,n=(0,r.Z)(e,o);return(0,l.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"connecting-clickhouse-to-postgresql-using-the-materializedpostgresql-database-engine"},"Connecting ClickHouse to PostgreSQL using the MaterializedPostgreSQL database engine"),(0,l.kt)("p",null,"The PostgreSQL database engine uses the PostgreSQL replication features to create a replica of the database with all or a subset of schemas and tables.\nThis article is to illustrate basic methods of integration using one database, one schema and one table."),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},(0,l.kt)("em",{parentName:"strong"},"In the following procedures, the PostgreSQL CLI (psql) and the ClickHouse CLI (clickhouse-client) are used. The PostgreSQL server is installed on linux. The following has minimum settings if the postgresql database is new test install"))),(0,l.kt)("h2",{id:"1-in-postgresql"},"1. In PostgreSQL"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"In ",(0,l.kt)("inlineCode",{parentName:"li"},"postgresql.conf"),", set minimum listen levels, replication wal level and replication slots:")),(0,l.kt)("p",null,"add the following entries:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"listen_addresses = '*' \nmax_replication_slots = 10\nwal_level = logical\n")),(0,l.kt)("p",null,(0,l.kt)("em",{parentName:"p"},"*ClickHouse needs minimum of ",(0,l.kt)("inlineCode",{parentName:"em"},"logical")," wal level and minimum ",(0,l.kt)("inlineCode",{parentName:"em"},"2")," replication slots")),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"Using an admin account, create a user to connect from ClickHouse:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE ROLE clickhouse_user SUPERUSER LOGIN PASSWORD 'ClickHouse_123';\n")),(0,l.kt)("p",null,(0,l.kt)("em",{parentName:"p"},"*for demonstration purposes, full superuser rights have been granted.")),(0,l.kt)("ol",{start:3},(0,l.kt)("li",{parentName:"ol"},"create a new database:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE DATABASE db1;\n")),(0,l.kt)("ol",{start:4},(0,l.kt)("li",{parentName:"ol"},"connect to the new database in ",(0,l.kt)("inlineCode",{parentName:"li"},"psql"),":")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\\connect db1\n")),(0,l.kt)("ol",{start:5},(0,l.kt)("li",{parentName:"ol"},"create a new table:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE table1 (\n    id         integer primary key,\n    column1    varchar(10)\n);\n")),(0,l.kt)("ol",{start:6},(0,l.kt)("li",{parentName:"ol"},"add initial rows:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO table1\n(id, column1)\nVALUES\n(1, 'abc'),\n(2, 'def');\n")),(0,l.kt)("ol",{start:7},(0,l.kt)("li",{parentName:"ol"},"Configure the PostgreSQLto allow connections to the new database with the new user for replication:\nbelow is the minimum entry to add to the ",(0,l.kt)("inlineCode",{parentName:"li"},"pg_hba.conf")," file:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"# TYPE  DATABASE        USER            ADDRESS                 METHOD\nhost    db1             clickhouse_user 192.168.1.0/24          password\n")),(0,l.kt)("p",null,(0,l.kt)("em",{parentName:"p"},"*for demonstration purposes, this is using clear text password authentication method. update the address line with either the subnet or the address of the server per PostgreSQL documentation")),(0,l.kt)("ol",{start:8},(0,l.kt)("li",{parentName:"ol"},"reload the ",(0,l.kt)("inlineCode",{parentName:"li"},"pg_hba.conf")," configuration with something like this (adjust for your version):")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"/usr/pgsql-12/bin/pg_ctl reload\n")),(0,l.kt)("ol",{start:9},(0,l.kt)("li",{parentName:"ol"},"Test the login with new ",(0,l.kt)("inlineCode",{parentName:"li"},"clickhouse_user"),":")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"}," psql -U clickhouse_user -W -d db1 -h <your_postgresql_host>\n")),(0,l.kt)("h2",{id:"2-in-clickhouse"},"2. In ClickHouse"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"log into the ClickHouse CLI")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"clickhouse-client --user default --password ClickHouse123!\n")),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"Enable the PosgreSQL experimental feature for the database engine:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"SET allow_experimental_database_materialized_postgresql=1\n")),(0,l.kt)("ol",{start:3},(0,l.kt)("li",{parentName:"ol"},"Create the new database to be replicated and define the intitial table:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE DATABASE db1_postgres\nENGINE = MaterializedPostgreSQL('postgres-host.domain.com:5432', 'db1', 'clickhouse_user', 'ClickHouse_123')\nSETTINGS materialized_postgresql_tables_list = 'table1';\n")),(0,l.kt)("p",null,"minimum options:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"parameter"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"example"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"host:port"),(0,l.kt)("td",{parentName:"tr",align:null},"hostname or IP and port"),(0,l.kt)("td",{parentName:"tr",align:null},"postgres-host.domain.com:5432")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"database"),(0,l.kt)("td",{parentName:"tr",align:null},"PostgreSQL database name"),(0,l.kt)("td",{parentName:"tr",align:null},"db1")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"user"),(0,l.kt)("td",{parentName:"tr",align:null},"username to connect to postgres"),(0,l.kt)("td",{parentName:"tr",align:null},"clickhouse_user")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"password"),(0,l.kt)("td",{parentName:"tr",align:null},"password to connect to postgres"),(0,l.kt)("td",{parentName:"tr",align:null},"ClickHouse_123")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"settings"),(0,l.kt)("td",{parentName:"tr",align:null},"additional settings for the engine"),(0,l.kt)("td",{parentName:"tr",align:null},"materialized_postgresql_tables_list = 'table1'")))),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"For complete guide to the PostgreSQL database engine, refer to: "),"\n",(0,l.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/engines/database-engines/materialized-postgresql/#settings"},"https://clickhouse.com/docs/en/engines/database-engines/materialized-postgresql/#settings")),(0,l.kt)("ol",{start:4},(0,l.kt)("li",{parentName:"ol"},"Verify initial table has data")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"ch_env_2 :) select * from db1_postgres.table1;\n\nSELECT *\nFROM db1_postgres.table1\n\nQuery id: df2381ac-4e30-4535-b22e-8be3894aaafc\n\n\u250c\u2500id\u2500\u252c\u2500column1\u2500\u2510\n\u2502  1 \u2502 abc     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500id\u2500\u252c\u2500column1\u2500\u2510\n\u2502  2 \u2502 def     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,l.kt)("h2",{id:"3-test-basic-replication"},"3. Test basic replication"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"In PostgreSQL, add new rows:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO table1\n(id, column1)\nVALUES\n(3, 'ghi'),\n(4, 'jkl');\n")),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"In ClickHouse, verify new rows are visible:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"ch_env_2 :) select * from db1_postgres.table1;\n\nSELECT *\nFROM db1_postgres.table1\n\nQuery id: b0729816-3917-44d3-8d1a-fed912fb59ce\n\n\u250c\u2500id\u2500\u252c\u2500column1\u2500\u2510\n\u2502  1 \u2502 abc     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500id\u2500\u252c\u2500column1\u2500\u2510\n\u2502  4 \u2502 jkl     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500id\u2500\u252c\u2500column1\u2500\u2510\n\u2502  3 \u2502 ghi     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500id\u2500\u252c\u2500column1\u2500\u2510\n\u2502  2 \u2502 def     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,l.kt)("h2",{id:"4-summary"},"4. Summary"),(0,l.kt)("p",null,"This integration guide focused on a simple example on how to replicate a database with a table, however, there exist more advanced options which include replicating the whole database or adding new tables and schemas to the existing replications. Although DDL commands are not supported for this replication, the engine can be set to detect changes and reload the tables when there are structural changes made."),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"For more features available for advanced options, please see the reference documenation:"),"\n",(0,l.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/engines/database-engines/materialized-postgresql/"},"https://clickhouse.com/docs/en/engines/database-engines/materialized-postgresql/")))}m.isMDXComponent=!0}}]);