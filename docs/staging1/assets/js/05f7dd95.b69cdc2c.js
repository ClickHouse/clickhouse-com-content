"use strict";(self.webpackChunkclickhouse=self.webpackChunkclickhouse||[]).push([[41270],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return h}});var o=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function n(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,o,r=function(e,t){if(null==e)return{};var a,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)a=i[o],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)a=i[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=o.createContext({}),c=function(e){var t=o.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):n(n({},t),e)),a},p=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(a),h=r,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||i;return a?o.createElement(m,n(n({ref:t},p),{},{components:a})):o.createElement(m,n({ref:t},p))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,n=new Array(i);n[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,n[1]=s;for(var c=2;c<i;c++)n[c]=a[c];return o.createElement.apply(null,n)}return o.createElement.apply(null,a)}d.displayName="MDXCreateElement"},982:function(e,t,a){a.r(t),a.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return u}});var o=a(87462),r=a(63366),i=(a(67294),a(3905)),n=["components"],s={sidebar_position:49,sidebar_label:"Data Backup"},l="Data Backup",c={unversionedId:"en/operations/backup",id:"en/operations/backup",title:"Data Backup",description:"data-backup}",source:"@site/docs/en/operations/backup.md",sourceDirName:"en/operations",slug:"/en/operations/backup",permalink:"/docs/staging1/docs/en/operations/backup",tags:[],version:"current",sidebarPosition:49,frontMatter:{sidebar_position:49,sidebar_label:"Data Backup"},sidebar:"tutorialSidebar",previous:{title:"SSL X.509 certificate authentication",permalink:"/docs/staging1/docs/en/operations/external-authenticators/ssl-x509"},next:{title:"Configuration Files",permalink:"/docs/staging1/docs/en/operations/configuration-files"}},p={},u=[{value:"Duplicating Source Data Somewhere Else",id:"duplicating-source-data-somewhere-else",level:2},{value:"Filesystem Snapshots",id:"filesystem-snapshots",level:2},{value:"clickhouse-copier",id:"clickhouse-copier",level:2},{value:"Manipulations with Parts",id:"manipulations-with-parts",level:2}],d={toc:u};function h(e){var t=e.components,a=(0,r.Z)(e,n);return(0,i.kt)("wrapper",(0,o.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"data-backup"},"Data Backup"),(0,i.kt)("p",null,"While ",(0,i.kt)("a",{parentName:"p",href:"/docs/staging1/docs/en/engines/table-engines/mergetree-family/replication"},"replication")," provides protection from hardware failures, it does not protect against human errors: accidental deletion of data, deletion of the wrong table or a table on the wrong cluster, and software bugs that result in incorrect data processing or data corruption. In many cases mistakes like these will affect all replicas. ClickHouse has built-in safeguards to prevent some types of mistakes \u2014 for example, by default ",(0,i.kt)("a",{parentName:"p",href:"/docs/staging1/docs/en/operations/server-configuration-parameters/settings#max-table-size-to-drop"},"you can\u2019t just drop tables with a MergeTree-like engine containing more than 50 Gb of data"),". However, these safeguards do not cover all possible cases and can be circumvented."),(0,i.kt)("p",null,"In order to effectively mitigate possible human errors, you should carefully prepare a strategy for backing up and restoring your data ",(0,i.kt)("strong",{parentName:"p"},"in advance"),"."),(0,i.kt)("p",null,"Each company has different resources available and business requirements, so there\u2019s no universal solution for ClickHouse backups and restores that will fit every situation. What works for one gigabyte of data likely won\u2019t work for tens of petabytes. There are a variety of possible approaches with their own pros and cons, which will be discussed below. It is a good idea to use several approaches instead of just one in order to compensate for their various shortcomings."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Keep in mind that if you backed something up and never tried to restore it, chances are that restore will not work properly when you actually need it (or at least it will take longer than business can tolerate). So whatever backup approach you choose, make sure to automate the restore process as well, and practice it on a spare ClickHouse cluster regularly."))),(0,i.kt)("h2",{id:"duplicating-source-data-somewhere-else"},"Duplicating Source Data Somewhere Else"),(0,i.kt)("p",null,"Often data that is ingested into ClickHouse is delivered through some sort of persistent queue, such as ",(0,i.kt)("a",{parentName:"p",href:"https://kafka.apache.org"},"Apache Kafka"),". In this case it is possible to configure an additional set of subscribers that will read the same data stream while it is being written to ClickHouse and store it in cold storage somewhere. Most companies already have some default recommended cold storage, which could be an object store or a distributed filesystem like ",(0,i.kt)("a",{parentName:"p",href:"https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/HdfsDesign.html"},"HDFS"),"."),(0,i.kt)("h2",{id:"filesystem-snapshots"},"Filesystem Snapshots"),(0,i.kt)("p",null,"Some local filesystems provide snapshot functionality (for example, ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/ZFS"},"ZFS"),"), but they might not be the best choice for serving live queries. A possible solution is to create additional replicas with this kind of filesystem and exclude them from the ",(0,i.kt)("a",{parentName:"p",href:"/docs/staging1/docs/en/engines/table-engines/special/distributed"},"Distributed")," tables that are used for ",(0,i.kt)("inlineCode",{parentName:"p"},"SELECT")," queries. Snapshots on such replicas will be out of reach of any queries that modify data. As a bonus, these replicas might have special hardware configurations with more disks attached per server, which would be cost-effective."),(0,i.kt)("h2",{id:"clickhouse-copier"},"clickhouse-copier"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"/docs/staging1/docs/en/operations/utilities/clickhouse-copier"},"clickhouse-copier")," is a versatile tool that was initially created to re-shard petabyte-sized tables. It can also be used for backup and restore purposes because it reliably copies data between ClickHouse tables and clusters."),(0,i.kt)("p",null,"For smaller volumes of data, a simple ",(0,i.kt)("inlineCode",{parentName:"p"},"INSERT INTO ... SELECT ...")," to remote tables might work as well."),(0,i.kt)("h2",{id:"manipulations-with-parts"},"Manipulations with Parts"),(0,i.kt)("p",null,"ClickHouse allows using the ",(0,i.kt)("inlineCode",{parentName:"p"},"ALTER TABLE ... FREEZE PARTITION ...")," query to create a local copy of table partitions. This is implemented using hardlinks to the ",(0,i.kt)("inlineCode",{parentName:"p"},"/var/lib/clickhouse/shadow/")," folder, so it usually does not consume extra disk space for old data. The created copies of files are not handled by ClickHouse server, so you can just leave them there: you will have a simple backup that does not require any additional external system, but it will still be prone to hardware issues. For this reason, it\u2019s better to remotely copy them to another location and then remove the local copies. Distributed filesystems and object stores are still a good options for this, but normal attached file servers with a large enough capacity might work as well (in this case the transfer will occur via the network filesystem or maybe ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Rsync"},"rsync"),").\nData can be restored from backup using the ",(0,i.kt)("inlineCode",{parentName:"p"},"ALTER TABLE ... ATTACH PARTITION ...")),(0,i.kt)("p",null,"For more information about queries related to partition manipulations, see the ",(0,i.kt)("a",{parentName:"p",href:"/docs/staging1/docs/en/sql-reference/statements/alter/partition#alter_manipulations-with-partitions"},"ALTER documentation"),"."),(0,i.kt)("p",null,"A third-party tool is available to automate this approach: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/AlexAkulov/clickhouse-backup"},"clickhouse-backup"),"."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/operations/backup/"},"Original article")," "))}h.isMDXComponent=!0}}]);