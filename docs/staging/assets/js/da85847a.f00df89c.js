"use strict";(self.webpackChunkclickhouse=self.webpackChunkclickhouse||[]).push([[832],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),p=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(i.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=p(n),d=r,k=m["".concat(i,".").concat(d)]||m[d]||u[d]||o;return n?a.createElement(k,l(l({ref:t},c),{},{components:n})):a.createElement(k,l({ref:t},c))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=m;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var p=2;p<o;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},32696:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return i},default:function(){return d},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return u}});var a=n(87462),r=n(63366),o=(n(67294),n(3905)),l=["components"],s={sidebar_position:69,sidebar_label:"C++ Guide",description:"A list of recommendations regarding coding style, naming convention, formatting and more"},i="How to Write C++ Code",p={unversionedId:"en/development/style",id:"en/development/style",title:"How to Write C++ Code",description:"A list of recommendations regarding coding style, naming convention, formatting and more",source:"@site/docs/en/development/style.md",sourceDirName:"en/development",slug:"/en/development/style",permalink:"/docs/en/development/style",tags:[],version:"current",sidebarPosition:69,frontMatter:{sidebar_position:69,sidebar_label:"C++ Guide",description:"A list of recommendations regarding coding style, naming convention, formatting and more"},sidebar:"tutorialSidebar",previous:{title:"Build on Linux for RISC-V 64",permalink:"/docs/en/development/build-cross-riscv"},next:{title:"Testing",permalink:"/docs/en/development/tests"}},c={},u=[{value:"General Recommendations",id:"general-recommendations",level:2},{value:"Formatting",id:"formatting",level:2},{value:"Comments",id:"comments",level:2},{value:"Names",id:"names",level:2},{value:"How to Write Code",id:"how-to-write-code",level:2},{value:"Unused Features of C++",id:"unused-features-of-c",level:2},{value:"Platform",id:"platform",level:2},{value:"Tools",id:"tools",level:2},{value:"Libraries",id:"libraries",level:2},{value:"General Recommendations",id:"general-recommendations-1",level:2},{value:"Additional Recommendations",id:"additional-recommendations",level:2}],m={toc:u};function d(e){var t=e.components,n=(0,r.Z)(e,l);return(0,o.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"how-to-write-c-code"},"How to Write C++ Code"),(0,o.kt)("h2",{id:"general-recommendations"},"General Recommendations"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," The following are recommendations, not requirements."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," If you are editing code, it makes sense to follow the formatting of the existing code."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," Code style is needed for consistency. Consistency makes it easier to read the code, and it also makes it easier to search the code."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4.")," Many of the rules do not have logical reasons; they are dictated by established practices."),(0,o.kt)("h2",{id:"formatting"},"Formatting"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," Most of the formatting will be done automatically by ",(0,o.kt)("inlineCode",{parentName:"p"},"clang-format"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," Indents are 4 spaces. Configure your development environment so that a tab adds four spaces."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," Opening and closing curly brackets must be on a separate line."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"inline void readBoolText(bool & x, ReadBuffer & buf)\n{\n    char tmp = '0';\n    readChar(tmp, buf);\n    x = tmp != '0';\n}\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4.")," If the entire function body is a single ",(0,o.kt)("inlineCode",{parentName:"p"},"statement"),", it can be placed on a single line. Place spaces around curly braces (besides the space at the end of the line)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"inline size_t mask() const                { return buf_size() - 1; }\ninline size_t place(HashValue x) const    { return x & mask(); }\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"5.")," For functions. Don\u2019t put spaces around brackets."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"void reinsert(const Value & x)\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"memcpy(&buf[place_value], &x, sizeof(x));\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"6.")," In ",(0,o.kt)("inlineCode",{parentName:"p"},"if"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"for"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"while")," and other expressions, a space is inserted in front of the opening bracket (as opposed to function calls)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"for (size_t i = 0; i < rows; i += storage.index_granularity)\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"7.")," Add spaces around binary operators (",(0,o.kt)("inlineCode",{parentName:"p"},"+"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"-"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"*"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"/"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"%"),", \u2026) and the ternary operator ",(0,o.kt)("inlineCode",{parentName:"p"},"?:"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"UInt16 year = (s[0] - '0') * 1000 + (s[1] - '0') * 100 + (s[2] - '0') * 10 + (s[3] - '0');\nUInt8 month = (s[5] - '0') * 10 + (s[6] - '0');\nUInt8 day = (s[8] - '0') * 10 + (s[9] - '0');\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"8.")," If a line feed is entered, put the operator on a new line and increase the indent before it."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'if (elapsed_ns)\n    message << " ("\n        << rows_read_on_server * 1000000000 / elapsed_ns << " rows/s., "\n        << bytes_read_on_server * 1000.0 / elapsed_ns << " MB/s.) ";\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"9.")," You can use spaces for alignment within a line, if desired."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"dst.ClickLogID         = click.LogID;\ndst.ClickEventID       = click.EventID;\ndst.ClickGoodEvent     = click.GoodEvent;\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"10.")," Don\u2019t use spaces around the operators ",(0,o.kt)("inlineCode",{parentName:"p"},"."),", ",(0,o.kt)("inlineCode",{parentName:"p"},"->"),"."),(0,o.kt)("p",null,"If necessary, the operator can be wrapped to the next line. In this case, the offset in front of it is increased."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"11.")," Do not use a space to separate unary operators (",(0,o.kt)("inlineCode",{parentName:"p"},"--"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"++"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"*"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"&"),", \u2026) from the argument."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"12.")," Put a space after a comma, but not before it. The same rule goes for a semicolon inside a ",(0,o.kt)("inlineCode",{parentName:"p"},"for")," expression."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"13.")," Do not use spaces to separate the ",(0,o.kt)("inlineCode",{parentName:"p"},"[]")," operator."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"14.")," In a ",(0,o.kt)("inlineCode",{parentName:"p"},"template <...>")," expression, use a space between ",(0,o.kt)("inlineCode",{parentName:"p"},"template")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"<"),"; no spaces after ",(0,o.kt)("inlineCode",{parentName:"p"},"<")," or before ",(0,o.kt)("inlineCode",{parentName:"p"},">"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"template <typename TKey, typename TValue>\nstruct AggregatedStatElement\n{}\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"15.")," In classes and structures, write ",(0,o.kt)("inlineCode",{parentName:"p"},"public"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"private"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"protected")," on the same level as ",(0,o.kt)("inlineCode",{parentName:"p"},"class/struct"),", and indent the rest of the code."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"template <typename T>\nclass MultiVersion\n{\npublic:\n    /// Version of object for usage. shared_ptr manage lifetime of version.\n    using Version = std::shared_ptr<const T>;\n    ...\n}\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"16.")," If the same ",(0,o.kt)("inlineCode",{parentName:"p"},"namespace")," is used for the entire file, and there isn\u2019t anything else significant, an offset is not necessary inside ",(0,o.kt)("inlineCode",{parentName:"p"},"namespace"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"17.")," If the block for an ",(0,o.kt)("inlineCode",{parentName:"p"},"if"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"for"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"while"),", or other expression consists of a single ",(0,o.kt)("inlineCode",{parentName:"p"},"statement"),", the curly brackets are optional. Place the ",(0,o.kt)("inlineCode",{parentName:"p"},"statement")," on a separate line, instead. This rule is also valid for nested ",(0,o.kt)("inlineCode",{parentName:"p"},"if"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"for"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"while"),", \u2026"),(0,o.kt)("p",null,"But if the inner ",(0,o.kt)("inlineCode",{parentName:"p"},"statement")," contains curly brackets or ",(0,o.kt)("inlineCode",{parentName:"p"},"else"),", the external block should be written in curly brackets."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"/// Finish write.\nfor (auto & stream : streams)\n    stream.second->finalize();\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"18.")," There shouldn\u2019t be any spaces at the ends of lines."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"19.")," Source files are UTF-8 encoded."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"20.")," Non-ASCII characters can be used in string literals."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'<< ", " << (timer.elapsed() / chunks_stats.hits) << " \u03bcsec/hit.";\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"21.")," Do not write multiple expressions in a single line."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"22.")," Group sections of code inside functions and separate them with no more than one empty line."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"23.")," Separate functions, classes, and so on with one or two empty lines."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"24.")," ",(0,o.kt)("inlineCode",{parentName:"p"},"A const")," (related to a value) must be written before the type name."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"//correct\nconst char * pos\nconst std::string & s\n//incorrect\nchar const * pos\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"25.")," When declaring a pointer or reference, the ",(0,o.kt)("inlineCode",{parentName:"p"},"*")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"&")," symbols should be separated by spaces on both sides."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"//correct\nconst char * pos\n//incorrect\nconst char* pos\nconst char *pos\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"26.")," When using template types, alias them with the ",(0,o.kt)("inlineCode",{parentName:"p"},"using")," keyword (except in the simplest cases)."),(0,o.kt)("p",null,"In other words, the template parameters are specified only in ",(0,o.kt)("inlineCode",{parentName:"p"},"using")," and aren\u2019t repeated in the code."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"using")," can be declared locally, such as inside a function."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"//correct\nusing FileStreams = std::map<std::string, std::shared_ptr<Stream>>;\nFileStreams streams;\n//incorrect\nstd::map<std::string, std::shared_ptr<Stream>> streams;\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"27.")," Do not declare several variables of different types in one statement."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"//incorrect\nint x, *y;\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"28.")," Do not use C-style casts."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"//incorrect\nstd::cerr << (int)c <<; std::endl;\n//correct\nstd::cerr << static_cast<int>(c) << std::endl;\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"29.")," In classes and structs, group members and functions separately inside each visibility scope."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"30.")," For small classes and structs, it is not necessary to separate the method declaration from the implementation."),(0,o.kt)("p",null,"The same is true for small methods in any classes or structs."),(0,o.kt)("p",null,"For templated classes and structs, do not separate the method declarations from the implementation (because otherwise they must be defined in the same translation unit)."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"31.")," You can wrap lines at 140 characters, instead of 80."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"32.")," Always use the prefix increment/decrement operators if postfix is not required."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"for (Names::const_iterator it = column_names.begin(); it != column_names.end(); ++it)\n")),(0,o.kt)("h2",{id:"comments"},"Comments"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," Be sure to add comments for all non-trivial parts of code."),(0,o.kt)("p",null,"This is very important. Writing the comment might help you realize that the code isn\u2019t necessary, or that it is designed wrong."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"/** Part of piece of memory, that can be used.\n  * For example, if internal_buffer is 1MB, and there was only 10 bytes loaded to buffer from file for reading,\n  * then working_buffer will have size of only 10 bytes\n  * (working_buffer.end() will point to position right after those 10 bytes available for read).\n  */\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," Comments can be as detailed as necessary."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," Place comments before the code they describe. In rare cases, comments can come after the code, on the same line."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"/** Parses and executes the query.\n*/\nvoid executeQuery(\n    ReadBuffer & istr, /// Where to read the query from (and data for INSERT, if applicable)\n    WriteBuffer & ostr, /// Where to write the result\n    Context & context, /// DB, tables, data types, engines, functions, aggregate functions...\n    BlockInputStreamPtr & query_plan, /// Here could be written the description on how query was executed\n    QueryProcessingStage::Enum stage = QueryProcessingStage::Complete /// Up to which stage process the SELECT query\n    )\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4.")," Comments should be written in English only."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"5.")," If you are writing a library, include detailed comments explaining it in the main header file."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"6.")," Do not add comments that do not provide additional information. In particular, do not leave empty comments like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"/*\n* Procedure Name:\n* Original procedure name:\n* Author:\n* Date of creation:\n* Dates of modification:\n* Modification authors:\n* Original file name:\n* Purpose:\n* Intent:\n* Designation:\n* Classes used:\n* Constants:\n* Local variables:\n* Parameters:\n* Date of creation:\n* Purpose:\n*/\n")),(0,o.kt)("p",null,"The example is borrowed from the resource ",(0,o.kt)("a",{parentName:"p",href:"http://home.tamk.fi/~jaalto/course/coding-style/doc/unmaintainable-code/"},"http://home.tamk.fi/~jaalto/course/coding-style/doc/unmaintainable-code/"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"7.")," Do not write garbage comments (author, creation date ..) at the beginning of each file."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"8.")," Single-line comments begin with three slashes: ",(0,o.kt)("inlineCode",{parentName:"p"},"///")," and multi-line comments begin with ",(0,o.kt)("inlineCode",{parentName:"p"},"/**"),". These comments are considered \u201cdocumentation\u201d."),(0,o.kt)("p",null,"Note: You can use Doxygen to generate documentation from these comments. But Doxygen is not generally used because it is more convenient to navigate the code in the IDE."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"9.")," Multi-line comments must not have empty lines at the beginning and end (except the line that closes a multi-line comment)."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"10.")," For commenting out code, use basic comments, not \u201cdocumenting\u201d comments."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"11.")," Delete the commented out parts of the code before committing."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"12.")," Do not use profanity in comments or code."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"13.")," Do not use uppercase letters. Do not use excessive punctuation."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"/// WHAT THE FAIL???\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"14.")," Do not use comments to make delimeters."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"///******************************************************\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"15.")," Do not start discussions in comments."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"/// Why did you do this stuff?\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"16.")," There\u2019s no need to write a comment at the end of a block describing what it was about."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"/// for\n")),(0,o.kt)("h2",{id:"names"},"Names"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," Use lowercase letters with underscores in the names of variables and class members."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"size_t max_block_size;\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," For the names of functions (methods), use camelCase beginning with a lowercase letter."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'std::string getName() const override { return "Memory"; }\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," For the names of classes (structs), use CamelCase beginning with an uppercase letter. Prefixes other than I are not used for interfaces."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"class StorageMemory : public IStorage\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4.")," ",(0,o.kt)("inlineCode",{parentName:"p"},"using")," are named the same way as classes."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"5.")," Names of template type arguments: in simple cases, use ",(0,o.kt)("inlineCode",{parentName:"p"},"T"),"; ",(0,o.kt)("inlineCode",{parentName:"p"},"T"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"U"),"; ",(0,o.kt)("inlineCode",{parentName:"p"},"T1"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"T2"),"."),(0,o.kt)("p",null,"For more complex cases, either follow the rules for class names, or add the prefix ",(0,o.kt)("inlineCode",{parentName:"p"},"T"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"template <typename TKey, typename TValue>\nstruct AggregatedStatElement\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"6.")," Names of template constant arguments: either follow the rules for variable names, or use ",(0,o.kt)("inlineCode",{parentName:"p"},"N")," in simple cases."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"template <bool without_www>\nstruct ExtractDomain\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"7.")," For abstract classes (interfaces) you can add the ",(0,o.kt)("inlineCode",{parentName:"p"},"I")," prefix."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"class IBlockInputStream\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"8.")," If you use a variable locally, you can use the short name."),(0,o.kt)("p",null,"In all other cases, use a name that describes the meaning."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"bool info_successfully_loaded = false;\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"9.")," Names of ",(0,o.kt)("inlineCode",{parentName:"p"},"define"),"s and global constants use ALL_CAPS with underscores."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"#define MAX_SRC_TABLE_NAMES_TO_STORE 1000\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"10.")," File names should use the same style as their contents."),(0,o.kt)("p",null,"If a file contains a single class, name the file the same way as the class (CamelCase)."),(0,o.kt)("p",null,"If the file contains a single function, name the file the same way as the function (camelCase)."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"11.")," If the name contains an abbreviation, then:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"For variable names, the abbreviation should use lowercase letters ",(0,o.kt)("inlineCode",{parentName:"li"},"mysql_connection")," (not ",(0,o.kt)("inlineCode",{parentName:"li"},"mySQL_connection"),")."),(0,o.kt)("li",{parentName:"ul"},"For names of classes and functions, keep the uppercase letters in the abbreviation",(0,o.kt)("inlineCode",{parentName:"li"},"MySQLConnection")," (not ",(0,o.kt)("inlineCode",{parentName:"li"},"MySqlConnection"),").")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"12.")," Constructor arguments that are used just to initialize the class members should be named the same way as the class members, but with an underscore at the end."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'FileQueueProcessor(\n    const std::string & path_,\n    const std::string & prefix_,\n    std::shared_ptr<FileHandler> handler_)\n    : path(path_),\n    prefix(prefix_),\n    handler(handler_),\n    log(&Logger::get("FileQueueProcessor"))\n{\n}\n')),(0,o.kt)("p",null,"The underscore suffix can be omitted if the argument is not used in the constructor body."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"13.")," There is no difference in the names of local variables and class members (no prefixes required)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"timer (not m_timer)\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"14.")," For the constants in an ",(0,o.kt)("inlineCode",{parentName:"p"},"enum"),", use CamelCase with a capital letter. ALL_CAPS is also acceptable. If the ",(0,o.kt)("inlineCode",{parentName:"p"},"enum")," is non-local, use an ",(0,o.kt)("inlineCode",{parentName:"p"},"enum class"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"enum class CompressionMethod\n{\n    QuickLZ = 0,\n    LZ4     = 1,\n};\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"15.")," All names must be in English. Transliteration of Hebrew words is not allowed."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"not T_PAAMAYIM_NEKUDOTAYIM\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"16.")," Abbreviations are acceptable if they are well known (when you can easily find the meaning of the abbreviation in Wikipedia or in a search engine)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"`AST`, `SQL`.\n\nNot `NVDH` (some random letters)\n")),(0,o.kt)("p",null,"Incomplete words are acceptable if the shortened version is common use."),(0,o.kt)("p",null,"You can also use an abbreviation if the full name is included next to it in the comments."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"17.")," File names with C++ source code must have the ",(0,o.kt)("inlineCode",{parentName:"p"},".cpp")," extension. Header files must have the ",(0,o.kt)("inlineCode",{parentName:"p"},".h")," extension."),(0,o.kt)("h2",{id:"how-to-write-code"},"How to Write Code"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," Memory management."),(0,o.kt)("p",null,"Manual memory deallocation (",(0,o.kt)("inlineCode",{parentName:"p"},"delete"),") can only be used in library code."),(0,o.kt)("p",null,"In library code, the ",(0,o.kt)("inlineCode",{parentName:"p"},"delete")," operator can only be used in destructors."),(0,o.kt)("p",null,"In application code, memory must be freed by the object that owns it."),(0,o.kt)("p",null,"Examples:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The easiest way is to place an object on the stack, or make it a member of another class."),(0,o.kt)("li",{parentName:"ul"},"For a large number of small objects, use containers."),(0,o.kt)("li",{parentName:"ul"},"For automatic deallocation of a small number of objects that reside in the heap, use ",(0,o.kt)("inlineCode",{parentName:"li"},"shared_ptr/unique_ptr"),".")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," Resource management."),(0,o.kt)("p",null,"Use ",(0,o.kt)("inlineCode",{parentName:"p"},"RAII")," and see above."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," Error handling."),(0,o.kt)("p",null,"Use exceptions. In most cases, you only need to throw an exception, and do not need to catch it (because of ",(0,o.kt)("inlineCode",{parentName:"p"},"RAII"),")."),(0,o.kt)("p",null,"In offline data processing applications, it\u2019s often acceptable to not catch exceptions."),(0,o.kt)("p",null,"In servers that handle user requests, it\u2019s usually enough to catch exceptions at the top level of the connection handler."),(0,o.kt)("p",null,"In thread functions, you should catch and keep all exceptions to rethrow them in the main thread after ",(0,o.kt)("inlineCode",{parentName:"p"},"join"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"/// If there weren't any calculations yet, calculate the first block synchronously\nif (!started)\n{\n    calculate();\n    started = true;\n}\nelse /// If calculations are already in progress, wait for the result\n    pool.wait();\n\nif (exception)\n    exception->rethrow();\n")),(0,o.kt)("p",null,"Never hide exceptions without handling. Never just blindly put all exceptions to log."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"//Not correct\ncatch (...) {}\n")),(0,o.kt)("p",null,"If you need to ignore some exceptions, do so only for specific ones and rethrow the rest."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"catch (const DB::Exception & e)\n{\n    if (e.code() == ErrorCodes::UNKNOWN_AGGREGATE_FUNCTION)\n        return nullptr;\n    else\n        throw;\n}\n")),(0,o.kt)("p",null,"When using functions with response codes or ",(0,o.kt)("inlineCode",{parentName:"p"},"errno"),", always check the result and throw an exception in case of error."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'if (0 != close(fd))\n    throwFromErrno("Cannot close file " + file_name, ErrorCodes::CANNOT_CLOSE_FILE);\n')),(0,o.kt)("p",null,"You can use assert to check invariants in code."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4.")," Exception types."),(0,o.kt)("p",null,"There is no need to use complex exception hierarchy in application code. The exception text should be understandable to a system administrator."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"5.")," Throwing exceptions from destructors."),(0,o.kt)("p",null,"This is not recommended, but it is allowed."),(0,o.kt)("p",null,"Use the following options:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Create a function (",(0,o.kt)("inlineCode",{parentName:"li"},"done()")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"finalize()"),") that will do all the work in advance that might lead to an exception. If that function was called, there should be no exceptions in the destructor later."),(0,o.kt)("li",{parentName:"ul"},"Tasks that are too complex (such as sending messages over the network) can be put in separate method that the class user will have to call before destruction."),(0,o.kt)("li",{parentName:"ul"},"If there is an exception in the destructor, it\u2019s better to log it than to hide it (if the logger is available)."),(0,o.kt)("li",{parentName:"ul"},"In simple applications, it is acceptable to rely on ",(0,o.kt)("inlineCode",{parentName:"li"},"std::terminate")," (for cases of ",(0,o.kt)("inlineCode",{parentName:"li"},"noexcept")," by default in C++11) to handle exceptions.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"6.")," Anonymous code blocks."),(0,o.kt)("p",null,"You can create a separate code block inside a single function in order to make certain variables local, so that the destructors are called when exiting the block."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"Block block = data.in->read();\n\n{\n    std::lock_guard<std::mutex> lock(mutex);\n    data.ready = true;\n    data.block = block;\n}\n\nready_any.set();\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"7.")," Multithreading."),(0,o.kt)("p",null,"In offline data processing programs:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Try to get the best possible performance on a single CPU core. You can then parallelize your code if necessary.")),(0,o.kt)("p",null,"In server applications:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Use the thread pool to process requests. At this point, we haven\u2019t had any tasks that required userspace context switching.")),(0,o.kt)("p",null,"Fork is not used for parallelization."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"8.")," Syncing threads."),(0,o.kt)("p",null,"Often it is possible to make different threads use different memory cells (even better: different cache lines,) and to not use any thread synchronization (except ",(0,o.kt)("inlineCode",{parentName:"p"},"joinAll"),")."),(0,o.kt)("p",null,"If synchronization is required, in most cases, it is sufficient to use mutex under ",(0,o.kt)("inlineCode",{parentName:"p"},"lock_guard"),"."),(0,o.kt)("p",null,"In other cases use system synchronization primitives. Do not use busy wait."),(0,o.kt)("p",null,"Atomic operations should be used only in the simplest cases."),(0,o.kt)("p",null,"Do not try to implement lock-free data structures unless it is your primary area of expertise."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"9.")," Pointers vs references."),(0,o.kt)("p",null,"In most cases, prefer references."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"10.")," const."),(0,o.kt)("p",null,"Use constant references, pointers to constants, ",(0,o.kt)("inlineCode",{parentName:"p"},"const_iterator"),", and const methods."),(0,o.kt)("p",null,"Consider ",(0,o.kt)("inlineCode",{parentName:"p"},"const")," to be default and use non-",(0,o.kt)("inlineCode",{parentName:"p"},"const")," only when necessary."),(0,o.kt)("p",null,"When passing variables by value, using ",(0,o.kt)("inlineCode",{parentName:"p"},"const")," usually does not make sense."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"11.")," unsigned."),(0,o.kt)("p",null,"Use ",(0,o.kt)("inlineCode",{parentName:"p"},"unsigned")," if necessary."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"12.")," Numeric types."),(0,o.kt)("p",null,"Use the types ",(0,o.kt)("inlineCode",{parentName:"p"},"UInt8"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"UInt16"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"UInt32"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"UInt64"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"Int8"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"Int16"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"Int32"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"Int64"),", as well as ",(0,o.kt)("inlineCode",{parentName:"p"},"size_t"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"ssize_t"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"ptrdiff_t"),"."),(0,o.kt)("p",null,"Don\u2019t use these types for numbers: ",(0,o.kt)("inlineCode",{parentName:"p"},"signed/unsigned long"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"long long"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"short"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"signed/unsigned char"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"char"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"13.")," Passing arguments."),(0,o.kt)("p",null,"Pass complex values by value if they are going to be moved and use std::move; pass by reference if you want to update value in a loop."),(0,o.kt)("p",null,"If a function captures ownership of an object created in the heap, make the argument type ",(0,o.kt)("inlineCode",{parentName:"p"},"shared_ptr")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"unique_ptr"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"14.")," Return values."),(0,o.kt)("p",null,"In most cases, just use ",(0,o.kt)("inlineCode",{parentName:"p"},"return"),". Do not write ",(0,o.kt)("inlineCode",{parentName:"p"},"return std::move(res)"),"."),(0,o.kt)("p",null,"If the function allocates an object on heap and returns it, use ",(0,o.kt)("inlineCode",{parentName:"p"},"shared_ptr")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"unique_ptr"),"."),(0,o.kt)("p",null,"In rare cases (updating a value in a loop) you might need to return the value via an argument. In this case, the argument should be a reference."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"using AggregateFunctionPtr = std::shared_ptr<IAggregateFunction>;\n\n/** Allows creating an aggregate function by its name.\n  */\nclass AggregateFunctionFactory\n{\npublic:\n    AggregateFunctionFactory();\n    AggregateFunctionPtr get(const String & name, const DataTypes & argument_types) const;\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"15.")," namespace."),(0,o.kt)("p",null,"There is no need to use a separate ",(0,o.kt)("inlineCode",{parentName:"p"},"namespace")," for application code."),(0,o.kt)("p",null,"Small libraries do not need this, either."),(0,o.kt)("p",null,"For medium to large libraries, put everything in a ",(0,o.kt)("inlineCode",{parentName:"p"},"namespace"),"."),(0,o.kt)("p",null,"In the library\u2019s ",(0,o.kt)("inlineCode",{parentName:"p"},".h")," file, you can use ",(0,o.kt)("inlineCode",{parentName:"p"},"namespace detail")," to hide implementation details not needed for the application code."),(0,o.kt)("p",null,"In a ",(0,o.kt)("inlineCode",{parentName:"p"},".cpp")," file, you can use a ",(0,o.kt)("inlineCode",{parentName:"p"},"static")," or anonymous namespace to hide symbols."),(0,o.kt)("p",null,"Also, a ",(0,o.kt)("inlineCode",{parentName:"p"},"namespace")," can be used for an ",(0,o.kt)("inlineCode",{parentName:"p"},"enum")," to prevent the corresponding names from falling into an external ",(0,o.kt)("inlineCode",{parentName:"p"},"namespace")," (but it\u2019s better to use an ",(0,o.kt)("inlineCode",{parentName:"p"},"enum class"),")."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"16.")," Deferred initialization."),(0,o.kt)("p",null,"If arguments are required for initialization, then you normally shouldn\u2019t write a default constructor."),(0,o.kt)("p",null,"If later you\u2019ll need to delay initialization, you can add a default constructor that will create an invalid object. Or, for a small number of objects, you can use ",(0,o.kt)("inlineCode",{parentName:"p"},"shared_ptr/unique_ptr"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"Loader(DB::Connection * connection_, const std::string & query, size_t max_block_size_);\n\n/// For deferred initialization\nLoader() {}\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"17.")," Virtual functions."),(0,o.kt)("p",null,"If the class is not intended for polymorphic use, you do not need to make functions virtual. This also applies to the destructor."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"18.")," Encodings."),(0,o.kt)("p",null,"Use UTF-8 everywhere. Use ",(0,o.kt)("inlineCode",{parentName:"p"},"std::string")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"char *"),". Do not use ",(0,o.kt)("inlineCode",{parentName:"p"},"std::wstring")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"wchar_t"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"19.")," Logging."),(0,o.kt)("p",null,"See the examples everywhere in the code."),(0,o.kt)("p",null,"Before committing, delete all meaningless and debug logging, and any other types of debug output."),(0,o.kt)("p",null,"Logging in cycles should be avoided, even on the Trace level."),(0,o.kt)("p",null,"Logs must be readable at any logging level."),(0,o.kt)("p",null,"Logging should only be used in application code, for the most part."),(0,o.kt)("p",null,"Log messages must be written in English."),(0,o.kt)("p",null,"The log should preferably be understandable for the system administrator."),(0,o.kt)("p",null,"Do not use profanity in the log."),(0,o.kt)("p",null,"Use UTF-8 encoding in the log. In rare cases you can use non-ASCII characters in the log."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"20.")," Input-output."),(0,o.kt)("p",null,"Don\u2019t use ",(0,o.kt)("inlineCode",{parentName:"p"},"iostreams")," in internal cycles that are critical for application performance (and never use ",(0,o.kt)("inlineCode",{parentName:"p"},"stringstream"),")."),(0,o.kt)("p",null,"Use the ",(0,o.kt)("inlineCode",{parentName:"p"},"DB/IO")," library instead."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"21.")," Date and time."),(0,o.kt)("p",null,"See the ",(0,o.kt)("inlineCode",{parentName:"p"},"DateLUT")," library."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"22.")," include."),(0,o.kt)("p",null,"Always use ",(0,o.kt)("inlineCode",{parentName:"p"},"#pragma once")," instead of include guards."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"23.")," using."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"using namespace")," is not used. You can use ",(0,o.kt)("inlineCode",{parentName:"p"},"using")," with something specific. But make it local inside a class or function."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"24.")," Do not use ",(0,o.kt)("inlineCode",{parentName:"p"},"trailing return type")," for functions unless necessary."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"auto f() -> void\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"25.")," Declaration and initialization of variables."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},'//right way\nstd::string s = "Hello";\nstd::string s{"Hello"};\n\n//wrong way\nauto s = std::string{"Hello"};\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"26.")," For virtual functions, write ",(0,o.kt)("inlineCode",{parentName:"p"},"virtual")," in the base class, but write ",(0,o.kt)("inlineCode",{parentName:"p"},"override")," instead of ",(0,o.kt)("inlineCode",{parentName:"p"},"virtual")," in descendent classes."),(0,o.kt)("h2",{id:"unused-features-of-c"},"Unused Features of C++"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," Virtual inheritance is not used."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," Exception specifiers from C++03 are not used."),(0,o.kt)("h2",{id:"platform"},"Platform"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," We write code for a specific platform."),(0,o.kt)("p",null,"But other things being equal, cross-platform or portable code is preferred."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," Language: C++20 (see the list of available ",(0,o.kt)("a",{parentName:"p",href:"https://en.cppreference.com/w/cpp/compiler_support#C.2B.2B20_features"},"C++20 features"),")."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," Compiler: ",(0,o.kt)("inlineCode",{parentName:"p"},"clang"),". At this time (April 2021), the code is compiled using clang version 11. (It can also be compiled using ",(0,o.kt)("inlineCode",{parentName:"p"},"gcc")," version 10, but it's untested and not suitable for production usage)."),(0,o.kt)("p",null,"The standard library is used (",(0,o.kt)("inlineCode",{parentName:"p"},"libc++"),")."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4."),"OS: Linux Ubuntu, not older than Precise."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"5."),"Code is written for x86_64 CPU architecture."),(0,o.kt)("p",null,"The CPU instruction set is the minimum supported set among our servers. Currently, it is SSE 4.2."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"6.")," Use ",(0,o.kt)("inlineCode",{parentName:"p"},"-Wall -Wextra -Werror")," compilation flags. Also ",(0,o.kt)("inlineCode",{parentName:"p"},"-Weverything")," is used with few exceptions."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"7.")," Use static linking with all libraries except those that are difficult to connect to statically (see the output of the ",(0,o.kt)("inlineCode",{parentName:"p"},"ldd")," command)."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"8.")," Code is developed and debugged with release settings."),(0,o.kt)("h2",{id:"tools"},"Tools"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," KDevelop is a good IDE."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," For debugging, use ",(0,o.kt)("inlineCode",{parentName:"p"},"gdb"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"valgrind")," (",(0,o.kt)("inlineCode",{parentName:"p"},"memcheck"),"), ",(0,o.kt)("inlineCode",{parentName:"p"},"strace"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"-fsanitize=..."),", or ",(0,o.kt)("inlineCode",{parentName:"p"},"tcmalloc_minimal_debug"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," For profiling, use ",(0,o.kt)("inlineCode",{parentName:"p"},"Linux Perf"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"valgrind")," (",(0,o.kt)("inlineCode",{parentName:"p"},"callgrind"),"), or ",(0,o.kt)("inlineCode",{parentName:"p"},"strace -cf"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4.")," Sources are in Git."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"5.")," Assembly uses ",(0,o.kt)("inlineCode",{parentName:"p"},"CMake"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"6.")," Programs are released using ",(0,o.kt)("inlineCode",{parentName:"p"},"deb")," packages."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"7.")," Commits to master must not break the build."),(0,o.kt)("p",null,"Though only selected revisions are considered workable."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"8.")," Make commits as often as possible, even if the code is only partially ready."),(0,o.kt)("p",null,"Use branches for this purpose."),(0,o.kt)("p",null,"If your code in the ",(0,o.kt)("inlineCode",{parentName:"p"},"master")," branch is not buildable yet, exclude it from the build before the ",(0,o.kt)("inlineCode",{parentName:"p"},"push"),". You\u2019ll need to finish it or remove it within a few days."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"9.")," For non-trivial changes, use branches and publish them on the server."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"10.")," Unused code is removed from the repository."),(0,o.kt)("h2",{id:"libraries"},"Libraries"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," The C++20 standard library is used (experimental extensions are allowed), as well as ",(0,o.kt)("inlineCode",{parentName:"p"},"boost")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Poco")," frameworks."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," It is not allowed to use libraries from OS packages. It is also not allowed to use pre-installed libraries. All libraries should be placed in form of source code in ",(0,o.kt)("inlineCode",{parentName:"p"},"contrib")," directory and built with ClickHouse. See ",(0,o.kt)("a",{parentName:"p",href:"/docs/en/development/contrib#adding-third-party-libraries"},"Guidelines for adding new third-party libraries")," for details."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," Preference is always given to libraries that are already in use."),(0,o.kt)("h2",{id:"general-recommendations-1"},"General Recommendations"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," Write as little code as possible."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," Try the simplest solution."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," Don\u2019t write code until you know how it\u2019s going to work and how the inner loop will function."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4.")," In the simplest cases, use ",(0,o.kt)("inlineCode",{parentName:"p"},"using")," instead of classes or structs."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"5.")," If possible, do not write copy constructors, assignment operators, destructors (other than a virtual one, if the class contains at least one virtual function), move constructors or move assignment operators. In other words, the compiler-generated functions must work correctly. You can use ",(0,o.kt)("inlineCode",{parentName:"p"},"default"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"6.")," Code simplification is encouraged. Reduce the size of your code where possible."),(0,o.kt)("h2",{id:"additional-recommendations"},"Additional Recommendations"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1.")," Explicitly specifying ",(0,o.kt)("inlineCode",{parentName:"p"},"std::")," for types from ",(0,o.kt)("inlineCode",{parentName:"p"},"stddef.h")),(0,o.kt)("p",null,"is not recommended. In other words, we recommend writing ",(0,o.kt)("inlineCode",{parentName:"p"},"size_t")," instead ",(0,o.kt)("inlineCode",{parentName:"p"},"std::size_t"),", because it\u2019s shorter."),(0,o.kt)("p",null,"It is acceptable to add ",(0,o.kt)("inlineCode",{parentName:"p"},"std::"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2.")," Explicitly specifying ",(0,o.kt)("inlineCode",{parentName:"p"},"std::")," for functions from the standard C library"),(0,o.kt)("p",null,"is not recommended. In other words, write ",(0,o.kt)("inlineCode",{parentName:"p"},"memcpy")," instead of ",(0,o.kt)("inlineCode",{parentName:"p"},"std::memcpy"),"."),(0,o.kt)("p",null,"The reason is that there are similar non-standard functions, such as ",(0,o.kt)("inlineCode",{parentName:"p"},"memmem"),". We do use these functions on occasion. These functions do not exist in ",(0,o.kt)("inlineCode",{parentName:"p"},"namespace std"),"."),(0,o.kt)("p",null,"If you write ",(0,o.kt)("inlineCode",{parentName:"p"},"std::memcpy")," instead of ",(0,o.kt)("inlineCode",{parentName:"p"},"memcpy")," everywhere, then ",(0,o.kt)("inlineCode",{parentName:"p"},"memmem")," without ",(0,o.kt)("inlineCode",{parentName:"p"},"std::")," will look strange."),(0,o.kt)("p",null,"Nevertheless, you can still use ",(0,o.kt)("inlineCode",{parentName:"p"},"std::")," if you prefer it."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3.")," Using functions from C when the same ones are available in the standard C++ library."),(0,o.kt)("p",null,"This is acceptable if it is more efficient."),(0,o.kt)("p",null,"For example, use ",(0,o.kt)("inlineCode",{parentName:"p"},"memcpy")," instead of ",(0,o.kt)("inlineCode",{parentName:"p"},"std::copy")," for copying large chunks of memory."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4.")," Multiline function arguments."),(0,o.kt)("p",null,"Any of the following wrapping styles are allowed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"function(\n  T1 x1,\n  T2 x2)\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"function(\n  size_t left, size_t right,\n  const & RangesInDataParts ranges,\n  size_t limit)\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"function(size_t left, size_t right,\n  const & RangesInDataParts ranges,\n  size_t limit)\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"function(size_t left, size_t right,\n      const & RangesInDataParts ranges,\n      size_t limit)\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cpp"},"function(\n      size_t left,\n      size_t right,\n      const & RangesInDataParts ranges,\n      size_t limit)\n")),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/development/style/"},"Original article")," "))}d.isMDXComponent=!0}}]);