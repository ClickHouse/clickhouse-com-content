"use strict";(self.webpackChunkclickhouse=self.webpackChunkclickhouse||[]).push([[21491],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,g=u["".concat(s,".").concat(m)]||u[m]||d[m]||i;return n?a.createElement(g,l(l({ref:t},p),{},{components:n})):a.createElement(g,l({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var c=2;c<i;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},76303:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return o},metadata:function(){return c},toc:function(){return d}});var a=n(87462),r=n(63366),i=(n(67294),n(3905)),l=["components"],o={sidebar_label:"Configuring LDAP",sidebar_position:20},s="Configuring ClickHouse to use LDAP for authentication and role mapping",c={unversionedId:"guides/admin/configuring-ldap",id:"guides/admin/configuring-ldap",title:"Configuring ClickHouse to use LDAP for authentication and role mapping",description:"ClickHouse can be configured to use LDAP to authenticate ClickHouse database users.",source:"@site/docs/guides/admin/configuring-ldap.md",sourceDirName:"guides/admin",slug:"/guides/admin/configuring-ldap",permalink:"/docs/staging/docs/guides/admin/configuring-ldap",tags:[],version:"current",sidebarPosition:20,frontMatter:{sidebar_label:"Configuring LDAP",sidebar_position:20},sidebar:"tutorialSidebar",previous:{title:"Configuring ClickHouse Keeper",permalink:"/docs/staging/docs/guides/admin/clickhouse-keeper"},next:{title:"Defining SQL Users and Roles",permalink:"/docs/staging/docs/guides/admin/users-and-roles"}},p={},d=[{value:"1. Configure LDAP connection settings in ClickHouse",id:"1-configure-ldap-connection-settings-in-clickhouse",level:2},{value:"2. Configure ClickHouse database roles and permissions",id:"2-configure-clickhouse-database-roles-and-permissions",level:2},{value:"3. Test the LDAP configuration",id:"3-test-the-ldap-configuration",level:2},{value:"4. Summary",id:"4-summary",level:2}],u={toc:d};function m(e){var t=e.components,n=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"configuring-clickhouse-to-use-ldap-for-authentication-and-role-mapping"},"Configuring ClickHouse to use LDAP for authentication and role mapping"),(0,i.kt)("p",null,"ClickHouse can be configured to use LDAP to authenticate ClickHouse database users.\nThis guide provides a simple example of integrating ClickHouse with an LDAP system authenticating to a publicly available directory."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("em",{parentName:"strong"},"In the following procedures the ClickHouse CLI is used."))),(0,i.kt)("h2",{id:"1-configure-ldap-connection-settings-in-clickhouse"},"1. Configure LDAP connection settings in ClickHouse"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Test connection to public ldap server:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ ldapsearch -x -b dc=example,dc=com -H ldap://ldap.forumsys.com\n")),(0,i.kt)("p",null,"the reply will be something like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"# extended LDIF\n#\n# LDAPv3\n# base <dc=example,dc=com> with scope subtree\n# filter: (objectclass=*)\n# requesting: ALL\n#\n\n# example.com\ndn: dc=example,dc=com\nobjectClass: top\nobjectClass: dcObject\nobjectClass: organization\no: example.com\ndc: example\n...\n")),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Edit the ",(0,i.kt)("inlineCode",{parentName:"li"},"config.xml")," file and add the following to configure ldap settings")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},"    <ldap_servers>\n        <test_ldap_server>\n           <host>ldap.forumsys.com</host>\n           <port>389</port>\n           <bind_dn>uid={user_name},dc=example,dc=com</bind_dn>\n           <enable_tls>no</enable_tls>\n           <tls_require_cert>never</tls_require_cert>\n        </test_ldap_server>\n    </ldap_servers>\n")),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"*the ",(0,i.kt)("inlineCode",{parentName:"em"},"<test_ldap_server>")," tags is an arbitrary label to identify a particular ldap server")),(0,i.kt)("p",null,"These are the basic settings used above:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"),(0,i.kt)("th",{parentName:"tr",align:null},"Example"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"host"),(0,i.kt)("td",{parentName:"tr",align:null},"hostname or IP of LDAP server"),(0,i.kt)("td",{parentName:"tr",align:null},"ldap.forumsys.com")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"port"),(0,i.kt)("td",{parentName:"tr",align:null},"directory port for LDAP server"),(0,i.kt)("td",{parentName:"tr",align:null},"389")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"bind_dn"),(0,i.kt)("td",{parentName:"tr",align:null},"template path to users"),(0,i.kt)("td",{parentName:"tr",align:null},"uid={user_name},dc=example,dc=com")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"enable_tls"),(0,i.kt)("td",{parentName:"tr",align:null},"whether to use secure ldap"),(0,i.kt)("td",{parentName:"tr",align:null},"no")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"tls_require_cert"),(0,i.kt)("td",{parentName:"tr",align:null},"whether to require certificate for connection"),(0,i.kt)("td",{parentName:"tr",align:null},"never")))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"In this example, since the public server uses 389 and does not use secure port, we disable TLS to allow it to connect for demonstration purposes."))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Below is link to the full configuration parameters available for the server definitions:")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/operations/external-authenticators/ldap/#ldap-server-definition"},"https://clickhouse.com/docs/en/operations/external-authenticators/ldap/#ldap-server-definition")),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"Add the ",(0,i.kt)("inlineCode",{parentName:"li"},"<ldap>")," section to ",(0,i.kt)("inlineCode",{parentName:"li"},"<user_directories>")," section to configure the user role mapping")),(0,i.kt)("p",null,"This section defines when a user is authenticated, what role the user will receive. In this basic example, any user authenticating to LDAP will receive the ",(0,i.kt)("inlineCode",{parentName:"p"},"scientists_role")," which will be defined at a later step in ClickHouse."),(0,i.kt)("p",null,"The section should look similar to this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},"    <user_directories>\n        <users_xml>\n            <path>users.xml</path>\n        </users_xml>\n        <local_directory>\n            <path>/var/lib/clickhouse/access/</path>\n        </local_directory>\n        <ldap>\n              <server>test_ldap_server</server>\n              <roles>\n                 <scientists_role />\n              </roles>\n              <role_mapping>\n                 <base_dn>dc=example,dc=com</base_dn>\n                 <search_filter>(&amp;(objectClass=groupOfUniqueNames)(uniqueMember={bind_dn}))</search_filter>\n                 <attribute>cn</attribute>\n              </role_mapping>\n        </ldap>\n    </user_directories>\n")),(0,i.kt)("p",null,"These are the basic settings used above:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"),(0,i.kt)("th",{parentName:"tr",align:null},"Example"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"server"),(0,i.kt)("td",{parentName:"tr",align:null},"label defined in the prior ldap_servers section"),(0,i.kt)("td",{parentName:"tr",align:null},"test_ldap_server")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"roles"),(0,i.kt)("td",{parentName:"tr",align:null},"name of the roles defined in ClickHouse the users will be mapped to"),(0,i.kt)("td",{parentName:"tr",align:null},"scientists_role")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"base_dn"),(0,i.kt)("td",{parentName:"tr",align:null},"base path to start search for groups with user"),(0,i.kt)("td",{parentName:"tr",align:null},"dc=example,dc=com")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"search_filter"),(0,i.kt)("td",{parentName:"tr",align:null},"ldap search filter to identify groups to select for mapping users"),(0,i.kt)("td",{parentName:"tr",align:null},"(","&","(objectClass=groupOfUniqueNames)(uniqueMember={bind_dn}))")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"attribute"),(0,i.kt)("td",{parentName:"tr",align:null},"which attribute name should value be returned from"),(0,i.kt)("td",{parentName:"tr",align:null},"cn")))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Below is link to the full configuration parameters available for the ldap group and role mapping:")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/operations/external-authenticators/ldap/#ldap-external-user-directory"},"https://clickhouse.com/docs/en/operations/external-authenticators/ldap/#ldap-external-user-directory")),(0,i.kt)("ol",{start:4},(0,i.kt)("li",{parentName:"ol"},"Restart ClickHouse server to apply settings.")),(0,i.kt)("h2",{id:"2-configure-clickhouse-database-roles-and-permissions"},"2. Configure ClickHouse database roles and permissions"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The procedures in this section assumes that SQL Access Control and Account Management in ClickHouse has been enabled. To enable see SQL Users and Roles admin guide."))),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Create a role in clickhouse with the same name used in the role mapping section of the ",(0,i.kt)("inlineCode",{parentName:"li"},"config.xml")," file")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE ROLE scientists_role;\n")),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Grant needed privileges to the role:")),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"*for demonstration purposes, the following grants admin privileges to any user able to authenticate through ldap.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT ALL ON *.* TO scientists_role;\n")),(0,i.kt)("h2",{id:"3-test-the-ldap-configuration"},"3. Test the LDAP configuration"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Login using the ClickHouse client")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ clickhouse-client --user einstein --password password\nClickHouse client version 22.2.2.1.\nConnecting to localhost:9000 as user einstein.\nConnected to ClickHouse server version 22.2.2 revision 54455.\n\nchnode1 :)\n")),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Use the ",(0,i.kt)("inlineCode",{parentName:"p"},"ldapsearch")," command in step 1 to view all of the users available in the directory and for all of the users the password is ",(0,i.kt)("inlineCode",{parentName:"p"},"password")))),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Test that the user was mapped correctly to the ",(0,i.kt)("inlineCode",{parentName:"li"},"scientists_role")," role and has admin permissions")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"chnode1 :) SHOW DATABASES;\n\nSHOW DATABASES\n\nQuery id: 93b785ff-1482-4eda-95b0-b2d68b2c5e0f\n\n\u250c\u2500name\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 INFORMATION_SCHEMA \u2502\n\u2502 db1_mysql          \u2502\n\u2502 db2                \u2502\n\u2502 db3                \u2502\n\u2502 db4_mysql          \u2502\n\u2502 db5_merge          \u2502\n\u2502 default            \u2502\n\u2502 information_schema \u2502\n\u2502 system             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n9 rows in set. Elapsed: 0.004 sec.\n")),(0,i.kt)("h2",{id:"4-summary"},"4. Summary"),(0,i.kt)("p",null,"This article demostrated the basics of configuring ClickHouse to authenticate to an LDAP server and also to map to a role.  There are also options for configuring individual users in ClickHouse but having those users be authenticated by LDAP without configuring automated role mapping. The LDAP module can also be used to connect to Active Directory."))}m.isMDXComponent=!0}}]);