<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-en/engines/table-engines/mergetree-family/replication">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">Data Replication | ClickHouse Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://clickhouse.com//docs/staging4/docs/en/engines/table-engines/mergetree-family/replication"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Data Replication | ClickHouse Docs"><meta data-rh="true" name="description" content="table_engines-replication}"><meta data-rh="true" property="og:description" content="table_engines-replication}"><link data-rh="true" rel="icon" href="/docs/staging4/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://clickhouse.com//docs/staging4/docs/en/engines/table-engines/mergetree-family/replication"><link data-rh="true" rel="alternate" href="https://clickhouse.com//docs/staging4/docs/en/engines/table-engines/mergetree-family/replication" hreflang="en"><link data-rh="true" rel="alternate" href="https://clickhouse.com//docs/staging4/docs/en/engines/table-engines/mergetree-family/replication" hreflang="x-default"><link rel="stylesheet" href="/docs/staging4/assets/css/styles.83a0a88b.css">
<link rel="preload" href="/docs/staging4/assets/js/runtime~main.1ca91862.js" as="script">
<link rel="preload" href="/docs/staging4/assets/js/main.d74cbdbf.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/staging4/docs/"><div class="navbar__logo"><img src="/docs/staging4/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docs/staging4/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">ClickHouse</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/staging4/docs/intro">Docs</a></div><div class="navbar__items navbar__items--right"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD sidebarWithHideableNavbar_d0QC"><a tabindex="-1" class="sidebarLogo_YUvz" href="/docs/staging4/docs/"><img src="/docs/staging4/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docs/staging4/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--dark_oUvU"><b>ClickHouse</b></a><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/staging4/docs/intro">What is ClickHouse?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/staging4/docs/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/staging4/docs/tutorial">Tutorial</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging4/docs/connect-a-ui">Connect a UI</a><button aria-label="Toggle the collapsible sidebar category &#x27;Connect a UI&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging4/docs/integrations">Integrations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Integrations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging4/docs/guides">User Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;User Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/staging4/docs/en">Reference Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/getting-started/install">Installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/getting-started/playground">Playground</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/en/example-datasets">Example Datasets</a><button aria-label="Toggle the collapsible sidebar category &#x27;Example Datasets&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/en/sql-reference/">SQL Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;SQL Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/staging4/docs/en/table-engines">Database &amp; Table Engines</a><button aria-label="Toggle the collapsible sidebar category &#x27;Database &amp; Table Engines&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/en/engines/database-engines/">Database Engines</a><button aria-label="Toggle the collapsible sidebar category &#x27;Database Engines&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/">Table Engines</a><button aria-label="Toggle the collapsible sidebar category &#x27;Table Engines&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/">MergeTree Family</a><button aria-label="Toggle the collapsible sidebar category &#x27;MergeTree Family&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/mergetree">MergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/replication">Data Replication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/custom-partitioning-key">Custom Partitioning Key</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/replacingmergetree">ReplacingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/summingmergetree">SummingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/aggregatingmergetree">AggregatingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/collapsingmergetree">CollapsingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/versionedcollapsingmergetree">VersionedCollapsingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/graphitemergetree">GraphiteMergeTree</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/log-family/">Log Family</a><button aria-label="Toggle the collapsible sidebar category &#x27;Log Family&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/integrations/">Integrations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Integrations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/en/engines/table-engines/special/">Special</a><button aria-label="Toggle the collapsible sidebar category &#x27;Special&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/en/interfaces/">Interfaces</a><button aria-label="Toggle the collapsible sidebar category &#x27;Interfaces&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/en/operations/">Operations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Operations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/category/building-clickhouse">Building ClickHouse</a><button aria-label="Toggle the collapsible sidebar category &#x27;Building ClickHouse&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging4/docs/en/whats-new/">What&#x27;s New</a><button aria-label="Toggle the collapsible sidebar category &#x27;What&#x27;s New&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging4/docs/faq/">FAQ</a><button aria-label="Toggle the collapsible sidebar category &#x27;FAQ&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging4/docs/about-us">About Us</a><button aria-label="Toggle the collapsible sidebar category &#x27;About Us&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/staging4/docs/en"><span itemprop="name">Reference Guides</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/staging4/docs/en/table-engines"><span itemprop="name">Database &amp; Table Engines</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/staging4/docs/en/engines/table-engines/"><span itemprop="name">Table Engines</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/"><span itemprop="name">MergeTree Family</span></a><meta itemprop="position" content="4"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">Data Replication</span><meta itemprop="position" content="5"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Data Replication</h1><p>Replication is only supported for tables in the MergeTree family:</p><ul><li>ReplicatedMergeTree</li><li>ReplicatedSummingMergeTree</li><li>ReplicatedReplacingMergeTree</li><li>ReplicatedAggregatingMergeTree</li><li>ReplicatedCollapsingMergeTree</li><li>ReplicatedVersionedCollapsingMergeTree</li><li>ReplicatedGraphiteMergeTree</li></ul><p>Replication works at the level of an individual table, not the entire server. A server can store both replicated and non-replicated tables at the same time.</p><p>Replication does not depend on sharding. Each shard has its own independent replication.</p><p>Compressed data for <code>INSERT</code> and <code>ALTER</code> queries is replicated (for more information, see the documentation for <a href="/docs/staging4/docs/en/sql-reference/statements/alter/#query_language_queries_alter">ALTER</a>).</p><p><code>CREATE</code>, <code>DROP</code>, <code>ATTACH</code>, <code>DETACH</code> and <code>RENAME</code> queries are executed on a single server and are not replicated:</p><ul><li>The <code>CREATE TABLE</code> query creates a new replicatable table on the server where the query is run. If this table already exists on other servers, it adds a new replica.</li><li>The <code>DROP TABLE</code> query deletes the replica located on the server where the query is run.</li><li>The <code>RENAME</code> query renames the table on one of the replicas. In other words, replicated tables can have different names on different replicas.</li></ul><p>ClickHouse uses <a href="https://zookeeper.apache.org" target="_blank" rel="noopener noreferrer">Apache ZooKeeper</a> for storing replicas meta information. Use ZooKeeper version 3.4.5 or newer.</p><p>To use replication, set parameters in the <a href="/docs/staging4/docs/en/operations/server-configuration-parameters/settings#server-settings_zookeeper">zookeeper</a> server configuration section.</p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Don’t neglect the security setting. ClickHouse supports the <code>digest</code> <a href="https://zookeeper.apache.org/doc/current/zookeeperProgrammers.html#sc_ZooKeeperAccessControl" target="_blank" rel="noopener noreferrer">ACL scheme</a> of the ZooKeeper security subsystem.</p></div></div><p>Example of setting the addresses of the ZooKeeper cluster:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">zookeeper</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">example1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">2181</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">example2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">2181</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">example3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">2181</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">zookeeper</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ClickHouse also supports to store replicas meta information in the auxiliary ZooKeeper cluster by providing ZooKeeper cluster name and path as engine arguments.
In other word, it supports to store the metadata of differnt tables in different ZooKeeper clusters.</p><p>Example of setting the addresses of the auxiliary ZooKeeper cluster:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">auxiliary_zookeepers</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">zookeeper2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">example_2_1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">2181</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">example_2_2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">2181</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">example_2_3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">2181</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">zookeeper2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">zookeeper3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">example_3_1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">host</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">2181</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">port</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">node</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">zookeeper3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">auxiliary_zookeepers</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>To store table datameta in a auxiliary ZooKeeper cluster instead of default ZooKeeper cluster, we can use the SQL to create table with
ReplicatedMergeTree engine as follow:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">CREATE TABLE table_name ( ... ) ENGINE = ReplicatedMergeTree(&#x27;zookeeper_name_configured_in_auxiliary_zookeepers:path&#x27;, &#x27;replica_name&#x27;) ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>You can specify any existing ZooKeeper cluster and the system will use a directory on it for its own data (the directory is specified when creating a replicatable table).</p><p>If ZooKeeper isn’t set in the config file, you can’t create replicated tables, and any existing replicated tables will be read-only.</p><p>ZooKeeper is not used in <code>SELECT</code> queries because replication does not affect the performance of <code>SELECT</code> and queries run just as fast as they do for non-replicated tables. When querying distributed replicated tables, ClickHouse behavior is controlled by the settings <a href="/docs/staging4/docs/en/operations/settings/#settings-max_replica_delay_for_distributed_queries">max_replica_delay_for_distributed_queries</a> and <a href="/docs/staging4/docs/en/operations/settings/#settings-fallback_to_stale_replicas_for_distributed_queries">fallback_to_stale_replicas_for_distributed_queries</a>.</p><p>For each <code>INSERT</code> query, approximately ten entries are added to ZooKeeper through several transactions. (To be more precise, this is for each inserted block of data; an INSERT query contains one block or one block per <code>max_insert_block_size = 1048576</code> rows.) This leads to slightly longer latencies for <code>INSERT</code> compared to non-replicated tables. But if you follow the recommendations to insert data in batches of no more than one <code>INSERT</code> per second, it does not create any problems. The entire ClickHouse cluster used for coordinating one ZooKeeper cluster has a total of several hundred <code>INSERTs</code> per second. The throughput on data inserts (the number of rows per second) is just as high as for non-replicated data.</p><p>For very large clusters, you can use different ZooKeeper clusters for different shards. However, from our experience this has not proven necessary based on production clusters with approximately 300 servers.</p><p>Replication is asynchronous and multi-master. <code>INSERT</code> queries (as well as <code>ALTER</code>) can be sent to any available server. Data is inserted on the server where the query is run, and then it is copied to the other servers. Because it is asynchronous, recently inserted data appears on the other replicas with some latency. If part of the replicas are not available, the data is written when they become available. If a replica is available, the latency is the amount of time it takes to transfer the block of compressed data over the network. The number of threads performing background tasks for replicated tables can be set by <a href="/docs/staging4/docs/en/operations/settings/#background_schedule_pool_size">background_schedule_pool_size</a> setting.</p><p><code>ReplicatedMergeTree</code> engine uses a separate thread pool for replicated fetches. Size of the pool is limited by the <a href="/docs/staging4/docs/en/operations/settings/#background_fetches_pool_size">background_fetches_pool_size</a> setting which can be tuned with a server restart.</p><p>By default, an INSERT query waits for confirmation of writing the data from only one replica. If the data was successfully written to only one replica and the server with this replica ceases to exist, the stored data will be lost. To enable getting confirmation of data writes from multiple replicas, use the <code>insert_quorum</code> option.</p><p>Each block of data is written atomically. The INSERT query is divided into blocks up to <code>max_insert_block_size = 1048576</code> rows. In other words, if the <code>INSERT</code> query has less than 1048576 rows, it is made atomically.</p><p>Data blocks are deduplicated. For multiple writes of the same data block (data blocks of the same size containing the same rows in the same order), the block is only written once. The reason for this is in case of network failures when the client application does not know if the data was written to the DB, so the <code>INSERT</code> query can simply be repeated. It does not matter which replica INSERTs were sent to with identical data. <code>INSERTs</code> are idempotent. Deduplication parameters are controlled by <a href="/docs/staging4/docs/en/operations/server-configuration-parameters/settings#server_configuration_parameters-merge_tree">merge_tree</a> server settings.</p><p>During replication, only the source data to insert is transferred over the network. Further data transformation (merging) is coordinated and performed on all the replicas in the same way. This minimizes network usage, which means that replication works well when replicas reside in different datacenters. (Note that duplicating data in different datacenters is the main goal of replication.)</p><p>You can have any number of replicas of the same data. Based on our experiences, a relatively reliable and convenient solution could use double replication in production, with each server using RAID-5 or RAID-6 (and RAID-10 in some cases). </p><p>The system monitors data synchronicity on replicas and is able to recover after a failure. Failover is automatic (for small differences in data) or semi-automatic (when data differs too much, which may indicate a configuration error).</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="creating-replicated-tables">Creating Replicated Tables<a class="hash-link" href="#creating-replicated-tables" title="Direct link to heading">​</a></h2><p>The <code>Replicated</code> prefix is added to the table engine name. For example:<code>ReplicatedMergeTree</code>.</p><p><strong>Replicated<!-- -->*<!-- -->MergeTree parameters</strong></p><ul><li><code>zoo_path</code> — The path to the table in ZooKeeper.</li><li><code>replica_name</code> — The replica name in ZooKeeper.</li><li><code>other_parameters</code> — Parameters of an engine which is used for creating the replicated version, for example, version in <code>ReplacingMergeTree</code>.</li></ul><p>Example:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> table_name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    EventDate </span><span class="token keyword" style="color:rgb(0, 0, 255)">DateTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    CounterID UInt32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    UserID UInt32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ver UInt16</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ReplicatedReplacingMergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;/clickhouse/tables/{layer}-{shard}/table_name&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;{replica}&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> ver</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> toYYYYMM</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">CounterID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> intHash32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SAMPLE </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> intHash32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><details markdown="1" class="details_lb9f alert alert--info details_BAp3" data-collapsed="true"><summary>Example in deprecated syntax</summary><div><div class="collapsibleContent_i85q"><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> table_name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    EventDate </span><span class="token keyword" style="color:rgb(0, 0, 255)">DateTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    CounterID UInt32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    UserID UInt32</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ReplicatedMergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;/clickhouse/tables/{layer}-{shard}/table_name&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;{replica}&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> intHash32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">CounterID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> intHash32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> EventTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></details><p>As the example shows, these parameters can contain substitutions in curly brackets. The substituted values are taken from the <a href="/docs/staging4/docs/en/operations/server-configuration-parameters/settings#macros">macros</a> section of the configuration file.</p><p>Example:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">macros</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">layer</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">05</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">layer</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">shard</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">02</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">shard</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">replica</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">example05-02-1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">replica</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">macros</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>The path to the table in ZooKeeper should be unique for each replicated table. Tables on different shards should have different paths.
In this case, the path consists of the following parts:</p><p><code>/clickhouse/tables/</code> is the common prefix. We recommend using exactly this one.</p><p><code>{layer}-{shard}</code> is the shard identifier. In this example it consists of two parts, since the example cluster uses bi-level sharding. For most tasks, you can leave just the {shard} substitution, which will be expanded to the shard identifier.</p><p><code>table_name</code> is the name of the node for the table in ZooKeeper. It is a good idea to make it the same as the table name. It is defined explicitly, because in contrast to the table name, it does not change after a RENAME query.
<em>HINT</em>: you could add a database name in front of <code>table_name</code> as well. E.g. <code>db_name.table_name</code></p><p>The two built-in substitutions <code>{database}</code> and <code>{table}</code> can be used, they expand into the table name and the database name respectively (unless these macros are defined in the <code>macros</code> section). So the zookeeper path can be specified as <code>&#x27;/clickhouse/tables/{layer}-{shard}/{database}/{table}&#x27;</code>.
Be careful with table renames when using these built-in substitutions. The path in Zookeeper cannot be changed, and when the table is renamed, the macros will expand into a different path, the table will refer to a path that does not exist in Zookeeper, and will go into read-only mode.</p><p>The replica name identifies different replicas of the same table. You can use the server name for this, as in the example. The name only needs to be unique within each shard.</p><p>You can define the parameters explicitly instead of using substitutions. This might be convenient for testing and for configuring small clusters. However, you can’t use distributed DDL queries (<code>ON CLUSTER</code>) in this case.</p><p>When working with large clusters, we recommend using substitutions because they reduce the probability of error.</p><p>You can specify default arguments for <code>Replicated</code> table engine in the server configuration file. For instance:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">default_replica_path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">/clickhouse/tables/{shard}/{database}/{table}</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">default_replica_path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">default_replica_name</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">{replica}</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">default_replica_name</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>In this case, you can omit arguments when creating tables:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> table_name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    x UInt32</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ReplicatedMergeTree</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>It is equivalent to:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> table_name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    x UInt32</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ReplicatedMergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;/clickhouse/tables/{shard}/{database}/table_name&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;{replica}&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Run the <code>CREATE TABLE</code> query on each replica. This query creates a new replicated table, or adds a new replica to an existing one.</p><p>If you add a new replica after the table already contains some data on other replicas, the data will be copied from the other replicas to the new one after running the query. In other words, the new replica syncs itself with the others.</p><p>To delete a replica, run <code>DROP TABLE</code>. However, only one replica is deleted – the one that resides on the server where you run the query.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="recovery-after-failures">Recovery After Failures<a class="hash-link" href="#recovery-after-failures" title="Direct link to heading">​</a></h2><p>If ZooKeeper is unavailable when a server starts, replicated tables switch to read-only mode. The system periodically attempts to connect to ZooKeeper.</p><p>If ZooKeeper is unavailable during an <code>INSERT</code>, or an error occurs when interacting with ZooKeeper, an exception is thrown.</p><p>After connecting to ZooKeeper, the system checks whether the set of data in the local file system matches the expected set of data (ZooKeeper stores this information). If there are minor inconsistencies, the system resolves them by syncing data with the replicas.</p><p>If the system detects broken data parts (with the wrong size of files) or unrecognized parts (parts written to the file system but not recorded in ZooKeeper), it moves them to the <code>detached</code> subdirectory (they are not deleted). Any missing parts are copied from the replicas.</p><p>Note that ClickHouse does not perform any destructive actions such as automatically deleting a large amount of data.</p><p>When the server starts (or establishes a new session with ZooKeeper), it only checks the quantity and sizes of all files. If the file sizes match but bytes have been changed somewhere in the middle, this is not detected immediately, but only when attempting to read the data for a <code>SELECT</code> query. The query throws an exception about a non-matching checksum or size of a compressed block. In this case, data parts are added to the verification queue and copied from the replicas if necessary.</p><p>If the local set of data differs too much from the expected one, a safety mechanism is triggered. The server enters this in the log and refuses to launch. The reason for this is that this case may indicate a configuration error, such as if a replica on a shard was accidentally configured like a replica on a different shard. However, the thresholds for this mechanism are set fairly low, and this situation might occur during normal failure recovery. In this case, data is restored semi-automatically - by “pushing a button”.</p><p>To start recovery, create the node <code>/path_to_table/replica_name/flags/force_restore_data</code> in ZooKeeper with any content, or run the command to restore all replicated tables:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> -u clickhouse </span><span class="token function" style="color:rgb(0, 0, 255)">touch</span><span class="token plain"> /var/lib/clickhouse/flags/force_restore_data</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Then restart the server. On start, the server deletes these flags and starts recovery.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="recovery-after-complete-data-loss">Recovery After Complete Data Loss<a class="hash-link" href="#recovery-after-complete-data-loss" title="Direct link to heading">​</a></h2><p>If all data and metadata disappeared from one of the servers, follow these steps for recovery:</p><ol><li>Install ClickHouse on the server. Define substitutions correctly in the config file that contains the shard identifier and replicas, if you use them.</li><li>If you had unreplicated tables that must be manually duplicated on the servers, copy their data from a replica (in the directory <code>/var/lib/clickhouse/data/db_name/table_name/</code>).</li><li>Copy table definitions located in <code>/var/lib/clickhouse/metadata/</code> from a replica. If a shard or replica identifier is defined explicitly in the table definitions, correct it so that it corresponds to this replica. (Alternatively, start the server and make all the <code>ATTACH TABLE</code> queries that should have been in the .sql files in <code>/var/lib/clickhouse/metadata/</code>.)</li><li>To start recovery, create the ZooKeeper node <code>/path_to_table/replica_name/flags/force_restore_data</code> with any content, or run the command to restore all replicated tables: <code>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data</code></li></ol><p>Then start the server (restart, if it is already running). Data will be downloaded from replicas.</p><p>An alternative recovery option is to delete information about the lost replica from ZooKeeper (<code>/path_to_table/replica_name</code>), then create the replica again as described in “<a href="#creating-replicated-tables">Creating replicated tables</a>”.</p><p>There is no restriction on network bandwidth during recovery. Keep this in mind if you are restoring many replicas at once.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="converting-from-mergetree-to-replicatedmergetree">Converting from MergeTree to ReplicatedMergeTree<a class="hash-link" href="#converting-from-mergetree-to-replicatedmergetree" title="Direct link to heading">​</a></h2><p>We use the term <code>MergeTree</code> to refer to all table engines in the <code>MergeTree family</code>, the same as for <code>ReplicatedMergeTree</code>.</p><p>If you had a <code>MergeTree</code> table that was manually replicated, you can convert it to a replicated table. You might need to do this if you have already collected a large amount of data in a <code>MergeTree</code> table and now you want to enable replication.</p><p>If the data differs on various replicas, first sync it, or delete this data on all the replicas except one.</p><p>Rename the existing MergeTree table, then create a <code>ReplicatedMergeTree</code> table with the old name.
Move the data from the old table to the <code>detached</code> subdirectory inside the directory with the new table data (<code>/var/lib/clickhouse/data/db_name/table_name/</code>).
Then run <code>ALTER TABLE ATTACH PARTITION</code> on one of the replicas to add these data parts to the working set.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="converting-from-replicatedmergetree-to-mergetree">Converting from ReplicatedMergeTree to MergeTree<a class="hash-link" href="#converting-from-replicatedmergetree-to-mergetree" title="Direct link to heading">​</a></h2><p>Create a MergeTree table with a different name. Move all the data from the directory with the <code>ReplicatedMergeTree</code> table data to the new table’s data directory. Then delete the <code>ReplicatedMergeTree</code> table and restart the server.</p><p>If you want to get rid of a <code>ReplicatedMergeTree</code> table without launching the server:</p><ul><li>Delete the corresponding <code>.sql</code> file in the metadata directory (<code>/var/lib/clickhouse/metadata/</code>).</li><li>Delete the corresponding path in ZooKeeper (<code>/path_to_table/replica_name</code>).</li></ul><p>After this, you can launch the server, create a <code>MergeTree</code> table, move the data to its directory, and then restart the server.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="recovery-when-metadata-in-the-zookeeper-cluster-is-lost-or-damaged">Recovery When Metadata in the Zookeeper Cluster Is Lost or Damaged<a class="hash-link" href="#recovery-when-metadata-in-the-zookeeper-cluster-is-lost-or-damaged" title="Direct link to heading">​</a></h2><p>If the data in ZooKeeper was lost or damaged, you can save data by moving it to an unreplicated table as described above.</p><p><strong>See Also</strong></p><ul><li><a href="/docs/staging4/docs/en/operations/settings/#background_schedule_pool_size">background_schedule_pool_size</a></li><li><a href="/docs/staging4/docs/en/operations/settings/#background_fetches_pool_size">background_fetches_pool_size</a></li><li><a href="/docs/staging4/docs/en/operations/settings/#execute-merges-on-single-replica-time-threshold">execute_merges_on_single_replica_time_threshold</a></li><li><a href="/docs/staging4/docs/en/operations/settings/merge-tree-settings#max_replicated_fetches_network_bandwidth">max_replicated_fetches_network_bandwidth</a></li><li><a href="/docs/staging4/docs/en/operations/settings/merge-tree-settings#max_replicated_sends_network_bandwidth">max_replicated_sends_network_bandwidth</a></li></ul><p><a href="https://clickhouse.com/docs/en/operations/table_engines/replication/" target="_blank" rel="noopener noreferrer">Original article</a> </p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/mergetree"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">MergeTree</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/staging4/docs/en/engines/table-engines/mergetree-family/custom-partitioning-key"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Custom Partitioning Key</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#creating-replicated-tables" class="table-of-contents__link toc-highlight">Creating Replicated Tables</a></li><li><a href="#recovery-after-failures" class="table-of-contents__link toc-highlight">Recovery After Failures</a></li><li><a href="#recovery-after-complete-data-loss" class="table-of-contents__link toc-highlight">Recovery After Complete Data Loss</a></li><li><a href="#converting-from-mergetree-to-replicatedmergetree" class="table-of-contents__link toc-highlight">Converting from MergeTree to ReplicatedMergeTree</a></li><li><a href="#converting-from-replicatedmergetree-to-mergetree" class="table-of-contents__link toc-highlight">Converting from ReplicatedMergeTree to MergeTree</a></li><li><a href="#recovery-when-metadata-in-the-zookeeper-cluster-is-lost-or-damaged" class="table-of-contents__link toc-highlight">Recovery When Metadata in the Zookeeper Cluster Is Lost or Damaged</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ClickHouse</div><ul class="footer__items"><li class="footer__item"><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Company</a></li><li class="footer__item"><a href="https://clickhouse.com/cloud/" target="_blank" rel="noopener noreferrer" class="footer__link-item">ClickHouse as a Service</a></li><li class="footer__item"><a href="https://clickhouse.com/careers/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Careers</a></li><li class="footer__item"><a href="https://clickhouse.com/learn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Learn ClickHouse</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ClickHouse/ClickHouse" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://clickhouse.com/blog/en/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/ClickHouseDB" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ClickHouseDB" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/clickhousedb/shared_invite/zt-rxm3rdrk-lIUmhLC3V8WTaL0TGxsOmg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Policies</div><ul class="footer__items"><li class="footer__item"><a href="https://clickhouse.com/legal/trademark-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trademark Policy</a></li><li class="footer__item"><a href="https://clickhouse.com/legal/privacy-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li><li class="footer__item"><a href="https://clickhouse.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/docs/staging4/img/logo.png" alt="ClickHouse Documentation" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/docs/staging4/img/logo.png" alt="ClickHouse Documentation" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></div><div class="footer__copyright">Copyright © 2016 - 2022 ClickHouse, Inc. ClickHouse Docs provided under the Creative Commons CC BY-NC-SA license. ClickHouse is a registered trademark of ClickHouse, Inc.</div></div></div></footer></div>
<script src="/docs/staging4/assets/js/runtime~main.1ca91862.js"></script>
<script src="/docs/staging4/assets/js/main.d74cbdbf.js"></script>
</body>
</html>