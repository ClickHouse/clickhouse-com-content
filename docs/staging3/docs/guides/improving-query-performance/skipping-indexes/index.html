<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-guides/improving-query-performance/skipping-indexes">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">Understanding ClickHouse Data Skipping Indexes | ClickHouse Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://clickhouse.com//docs/staging3/docs/guides/improving-query-performance/skipping-indexes/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Understanding ClickHouse Data Skipping Indexes | ClickHouse Docs"><meta data-rh="true" name="description" content="Introduction to Skipping Indexes"><meta data-rh="true" property="og:description" content="Introduction to Skipping Indexes"><link data-rh="true" rel="icon" href="/docs/staging3/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://clickhouse.com//docs/staging3/docs/guides/improving-query-performance/skipping-indexes/"><link data-rh="true" rel="alternate" href="https://clickhouse.com//docs/staging3/docs/guides/improving-query-performance/skipping-indexes/" hreflang="en"><link data-rh="true" rel="alternate" href="https://clickhouse.com//docs/staging3/docs/guides/improving-query-performance/skipping-indexes/" hreflang="x-default"><link rel="stylesheet" href="/docs/staging3/assets/css/styles.c4f08da8.css">
<link rel="preload" href="/docs/staging3/assets/js/runtime~main.bd77b7df.js" as="script">
<link rel="preload" href="/docs/staging3/assets/js/main.78e8e152.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/staging3/docs/"><div class="navbar__logo"><img src="/docs/staging3/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docs/staging3/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">ClickHouse</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/staging3/docs/intro/">Docs</a></div><div class="navbar__items navbar__items--right"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD sidebarWithHideableNavbar_d0QC"><a tabindex="-1" class="sidebarLogo_YUvz" href="/docs/staging3/docs/"><img src="/docs/staging3/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docs/staging3/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--dark_oUvU"><b>ClickHouse</b></a><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/staging3/docs/intro/">What is ClickHouse?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/staging3/docs/quick-start/">Quick Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/staging3/docs/tutorial/">Tutorial</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging3/docs/connect-a-ui/">Connect a UI</a><button aria-label="Toggle the collapsible sidebar category &#x27;Connect a UI&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging3/docs/integrations/">Integrations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Integrations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/staging3/docs/guides/">User Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;User Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging3/docs/guides/developer/">Developer Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/staging3/docs/guides/improving-query-performance/">Improving Query Performance</a><button aria-label="Toggle the collapsible sidebar category &#x27;Improving Query Performance&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/staging3/docs/guides/improving-query-performance/skipping-indexes/">Data Skipping Indexes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/staging3/docs/guides/improving-query-performance/sparse-primary-indexes/">Sparse Primary Indexes</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/staging3/docs/guides/sre/">SRE Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;SRE Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging3/docs/en/">Reference Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging3/docs/faq/">FAQ</a><button aria-label="Toggle the collapsible sidebar category &#x27;FAQ&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/staging3/docs/about-us/">About Us</a><button aria-label="Toggle the collapsible sidebar category &#x27;About Us&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/staging3/docs/guides/"><span itemprop="name">User Guides</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/staging3/docs/guides/improving-query-performance/"><span itemprop="name">Improving Query Performance</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">Data Skipping Indexes</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Understanding ClickHouse Data Skipping Indexes</h1><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="introduction-to-skipping-indexes">Introduction to Skipping Indexes<a class="hash-link" href="#introduction-to-skipping-indexes" title="Direct link to heading">​</a></h3><p>Many factors affect ClickHouse query performance. The critical element in most scenarios is whether ClickHouse can use the primary key when evaluating the query WHERE clause condition. Accordingly, selecting a primary key that applies to the most common query patterns is essential for effective table design.</p><p>Neverthelss, no matter how carefully tuned the primary key, there will inevitably be query use cases that can not efficiently use it. Users commonly rely on ClickHouse for time series type data, but they often wish to analyze that same data according to other business dimensions, such as customer id, website URL, or product number. In that case, query performance can be considerably worse because a full scan of each column value may be required to apply the WHERE clause condition. While ClickHouse is still relatively fast in those circumstances, evaluating millions or billions of individual values will cause &quot;non-indexed&quot; queries to execute much more slowly than those based on the primary key.</p><p>In a traditional relational database, one approach to this problem is to attach one or more &quot;secondary&quot; indexes to a table. This is a b-tree structure that permits the database to find all matching rows on disk in O(log(n)) time instead of O(n) time (a table scan), where n is the number of rows. However, this type of secondary index will not work for ClickHouse (or other column-oriented databases) because there are no individual rows on the disk to add to the index.</p><p>Instead, ClickHouse provides a different type of index, which in specific circumstances can significantly improve query speed. These structures are labeled &quot;Skip&quot; indexes because they enable ClickHouse to skip reading significant chunks of data that are guaranteed to have no matching values.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="basic-operation">Basic Operation<a class="hash-link" href="#basic-operation" title="Direct link to heading">​</a></h3><p>Users can only employ Data Skipping Indexes on the MergeTree family of tables. Each data skipping has four primary arguments:</p><ul><li>Index name. The index name is used to create the index file in each partition. Also, it is required as a parameter when dropping or materializing the index.</li><li>Index expression. The index expression is used to calculate the set of values stored in the index. It can be a combination of columns, simple operators, and/or a subset of functions determined by the index type.</li><li>TYPE. The type of index controls the calculation that determines if it is possible to skip reading and evaluating each index block.</li><li>GRANULARITY. Each indexed block consists of GRANULARITY granules. For example, if the granularity of the primary table index is 8192 rows, and the index granularity is 4, each indexed &quot;block&quot; will be 32768 rows.</li></ul><p>When a user creates a data skipping index, there will be two additional files in each data part directory for the table.</p><ul><li>skp<em>idx</em>{index_name}.idx, which contains the ordered expression values)</li><li>skp<em>idx</em>{index_name}.mrk2, which contains the corresponding offsets into the associated data column files.</li></ul><p>If some portion of the WHERE clause filtering condition matches the skip index expression when executing a query and reading the relevant column files, ClickHouse will use the index file data to determine whether each relevant block of data must be processed or can be bypassed (assuming that the block has not already been excluded by applying the primary key). To use a very simplified example, consider the following table loaded with predictable data.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">CREATE TABLE skip_table</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">(</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  my_key UInt64,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  my_value UInt64</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ENGINE MergeTree primary key my_key</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SETTINGS index_granularity=8192;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">INSERT INTO skip_table SELECT number, intDiv(number,4096) FROM numbers(100000000);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>When executing a simple query that does not use the primary key, all 100 million entries in the <code>my_value</code>
column are scanned:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">SELECT * FROM skip_table WHERE my_value IN (125, 700)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">┌─my_key─┬─my_value─┐</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 512000 │      125 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 512001 │      125 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│    ... |      ... |</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└────────┴──────────┘</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">8192 rows in set. Elapsed: 0.079 sec. Processed 100.00 million rows, 800.10 MB (1.26 billion rows/s., 10.10 GB/s.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Now add a very basic skip index:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">ALTER TABLE skip_table ADD INDEX vix my_value TYPE set(100) GRANULARITY 2;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Normally skip indexes are only applied on newly inserted data, so just adding the index won&#x27;t affect the above query.</p><p>To index already existing data, use this statement:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">ALTER TABLE skip_table MATERIALIZE INDEX vix;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Rerun the query with the newly created index:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">SELECT * FROM skip_table WHERE my_value IN (125, 700)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">┌─my_key─┬─my_value─┐</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 512000 │      125 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 512001 │      125 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│    ... |      ... |</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└────────┴──────────┘</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">8192 rows in set. Elapsed: 0.051 sec. Processed 32.77 thousand rows, 360.45 KB (643.75 thousand rows/s., 7.08 MB/s.)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Instead of processing 100 million rows of 800 megabytes, ClickHouse has only read and analyzed 32768 rows of 360 kilobytes
-- four granules of 8192 rows each.</p><p>In a more visual form, this is how the 4096 rows with a <code>my_value</code> of 125 were read and selected, and how the following rows
were skipped without reading from disk:</p><p><img loading="lazy" alt="Simple Skip" src="/docs/staging3/assets/images/simple_skip-52c0988d126255fdb7aa8ad94036b1f7.svg" width="595" height="518" class="img_E7b_"></p><p>Users can access detailed information about skip index usage by enabling the trace when executing queries.  From
clickhouse-client, set the send_logs_level:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">SET send_logs_level=&#x27;trace&#x27;;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>This will provide useful debugging information when trying to tune query SQL and table indexes.  From the above
above example, the debug log shows that the skip index dropped all but two granules:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">&lt;Debug&gt; default.skip_table (933d4b2c-8cea-4bf9-8c93-c56e900eefd1) (SelectExecutor): Index `vix` has dropped 6102/6104 granules.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skip-index-types">Skip Index Types<a class="hash-link" href="#skip-index-types" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="minmax">minmax<a class="hash-link" href="#minmax" title="Direct link to heading">​</a></h4><p>This lightweight index type requires no parameters.  It stores the minimum and maximum values of the index expression
for each block (if the expression is a tuple, it separately stores the values for each member of the element
of the tuple).  This type is ideal for columns that tend to be loosely sorted by value.  This index type is usually the least expensive to apply during query processing.</p><p>This type of index only works correctly with a scalar or tuple expression -- the index will never be applied to expressions that return an array or map data type.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="set">set<a class="hash-link" href="#set" title="Direct link to heading">​</a></h4><p>This lightweight index type accepts a single parameter of the max_size of the value set per block (0 permits
an unlimited number of discrete values).  This set contains all values in the block (or is empty if the number of values exceeds the max_size).  This index type works well with columns with low cardinality within each set of granules (essentially, &quot;clumped together&quot;) but higher cardinality overall.</p><p>The cost, performance, and effectiveness of this index is dependent on the cardinality within blocks.  If each block contains a large number of unique values, either evaluating the query condition against a large index set will be very expensive, or the index will not be applied because the index is empty due to exceeding max_size.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bloom-filter-types">Bloom Filter Types<a class="hash-link" href="#bloom-filter-types" title="Direct link to heading">​</a></h4><p>A <em>Bloom filter</em> is a data structure that allows space-efficient testing of set membership at the cost of a slight chance of false positives. A false positive is not a significant concern in the case of skip indexes because the only disadvantage is reading a few unnecessary blocks. However, the potential for false positives does mean that the indexed expression should be expected to be true, otherwise valid data may be skipped.</p><p>Because Bloom filters can more efficiently handle testing for a large number of discrete values, they can be appropriate for conditional expressions that produce more values to test. In particular, a Bloom filter index can be applied to arrays, where every value of the array is tested, and to maps, by converting either the keys or values to an array using the mapKeys or mapValues function.</p><p>There are three Data Skipping Index types based on Bloom filters:</p><ul><li><p>The basic <strong>bloom_filter</strong> which takes a single optional parameter of the allowed &quot;false positive&quot; rate between 0 and 1 (if unspecified, .025 is used).</p></li><li><p>The specialized <strong>tokenbf_v1</strong>. It takes three parameters, all related to tuning the bloom filter used:  (1) the size of the filter in bytes (larger filters have fewer false positives, at some cost in storage), (2) number of hash functions applied (again, more hash filters reduce false positives), and (3) the seed for the bloom filter hash functions.  See the calculator <a href="https://hur.st/bloomfilter/" target="_blank" rel="noopener noreferrer">here</a> for more detail on how these parameters affect bloom filter functionality.
This index works only with String, FixedString, and Map datatypes. The input expression is split into character sequences separated by non-alphanumeric characters. For example, a column value of <code>This is a candidate for a &quot;full text&quot; search</code> will contain the tokens <code>This</code> <code>is</code> <code>a</code> <code>candidate</code> <code>for</code> <code>full</code> <code>text</code> <code>search</code>.  It is intended for use in LIKE, EQUALS, IN, hasToken() and similar searches for words and other values within longer strings.  For example, one possible use might be searching for a small number of class names or line numbers in a column of free form application log lines.</p></li><li><p>The specialized <strong>ngrambf_v1</strong>. This index functions the same as the token index.  It takes one additional parameter before the Bloom filter settings, the size of the ngrams to index.  An ngram is a character string of length <code>n</code> of any characters, so the string <code>A short string</code> with an ngram size of 4 would be indexed as <code>A sh`` sho</code>, <code>shor</code>, <code>hort</code>, <code>ort s</code>, <code>or st</code>, <code>r str</code>, <code> stri</code>, <code>trin</code>, <code>ring</code>.  This index can also be useful for text searches, particularly languages without word breaks, such as Chinese.</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skip-index-functions">Skip Index Functions<a class="hash-link" href="#skip-index-functions" title="Direct link to heading">​</a></h3><p>The core purpose of data-skipping indexes is to limit the amount of data analyzed by popular queries. Given the analytic nature of ClickHouse data, the pattern of those queries in most cases includes functional expressions. Accordingly, skip indexes must interact correctly with common functions to be efficient. This can happen either when:
• data is inserted and the index is defined as a functional expression (with the result of the expression stored in the index files), or
• the query is processed and the expression is applied to the stored index values to determine whether to exclude the block.</p><p>Each type of skip index works on a subset of available ClickHouse functions appropriate to the index implementation listed
<a href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#functions-support" target="_blank" rel="noopener noreferrer">here</a>. In general, set indexes and Bloom filter based indexes (another type of set index) are both unordered and therefore do not work with ranges. In contrast, minmax indexes work particularly well with ranges since determining whether ranges intersect is very fast. The efficacy of partial match functions LIKE, startsWith, endsWith, and hasToken depend on the index type used, the index expression, and the particular shape of the data.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skip-index-settings">Skip Index Settings<a class="hash-link" href="#skip-index-settings" title="Direct link to heading">​</a></h3><p>There are two available settings that apply to skip indexes.</p><ul><li><strong>use_skip_indexes</strong>  (0 or 1, default 1).  Not all queries can efficiently use skip indexes.  If a particular filtering condition is
likely to include most granules, applying the data skipping index incurs an unnecessary, and sometimes significant, cost.  Set the value to
0 for queries that are unlikely to benefit from any skip indexes.</li><li><strong>force_data_skipping_indexes</strong> (comma separated list of index names).  This setting can be used to prevent some kinds of inefficient
queries.  In circumstances where querying a table is too expensive unless a skip index is used, using this setting with one or more index
names will return an exception for any query that does not use the listed index.  This would prevent poorly written queries from
consuming server resources.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skip-best-practices">Skip Best Practices<a class="hash-link" href="#skip-best-practices" title="Direct link to heading">​</a></h3><p>Skip indexes are not intuitive, especially for users accustomed to secondary row-based indexes from the RDMS realm or inverted indexes from document stores. To get any benefit, applying a ClickHouse data skipping index must avoid enough granule reads to offset the cost of calculating the index. Critically, if a value occurs even once in an indexed block, it means the entire block must be read into memory and evaluated, and the index cost has been needlessly incurred.</p><p>Consider the following data distribution:</p><p><img loading="lazy" alt="Bad Skip!" src="/docs/staging3/assets/images/bad_skip_1-43ca5929727f9e32bf386d7687525d1b.svg" width="726" height="517" class="img_E7b_"></p><p>Assume the primary/order by key is <code>timestamp</code>, and there is an index on <code>visitor_id</code>.  Consider the following query:</p><p> <code>SELECT timestamp, url FROM table WHERE visitor_id = 1001</code></p><p>A traditional secondary index would be very advantageous with this kind of data distribution.  Instead of reading all 32678 rows to find
the 5 rows with the requested visitor_id, the secondary index would include just five row locations, and only those five rows would be
read from disk.  The exact opposite is true for a ClickHouse data skipping index.  All 32678 values in the <code>visitor_id</code> column will be tested
regardless of the type of skip index.</p><p>Accordingly, the natural impulse to try to speed up ClickHouse queries by simply adding an index to key
columns is often incorrect.  This advanced functionality should only be used after investigating other alternatives, such as modifying the primary key (see <a href="/docs/staging3/docs/guides/improving-query-performance/sparse-primary-indexes/">How to Pick a Primary Key</a>), using projections, or using materialized views. Even when a data skipping index is appropriate, careful tuning both the index and the table
will often be necessary.</p><p>In most cases a useful skip index requires a strong correlation between the primary key and the targeted, non-primary column/expression.
If there is no correlation (as in the above diagram), the chances of the filtering condition being met by at least one of the rows in
the block of several thousand values is high and few blocks will be skipped.  In constrast, if a range of values for the primary key (like time of
day) is strongly associated with the values in the potential index column (such as television viewer ages), then a minmax type of index
is likely to be beneficial.  Note that it may be possible to increase this correlation when inserting data, either by including additional
columns in the sorting/ORDER BY key, or batching inserts in a way that values associated with the primary key are grouped on insert.  For
example, all of the events for a particular site_id could be grouped and inserted together by the ingest process, even if the primary key
is a timestamp containing events from a large number of sites.  This will result in many granules that contains only a few site ids, so many
blocks could be skipped when searching by a specific site_id value.</p><p>Another good candidate for a skip index is for high cardinality expressions where any one value is relatively sparse in the data.  One example
might be an observability platform that tracks error codes in API requests.  Certain error codes, while rare in the data, might be particularly
important for searches.  A set skip index on the error_code column would allow bypassing the vast majority of blocks that don&#x27;t contain
errors and therefore significantly improve error focused queries.</p><p>Finally, the key best practice is to test, test, test. Again, unlike b-tree secondary indexes or inverted indexes for searching documents,
data skipping index behavior is not easily predictable. Adding them to a table incurs a meangingful cost both on data ingest and on queries
that for any number of reasons don&#x27;t benefit from the index. They should always be tested on real world type of data, and testing should
include variations of the type, granularity size and other parameters. Testing will often reveal patterns and pitfalls that aren&#x27;t obvious from
thought experiments alone.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/staging3/docs/guides/improving-query-performance/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Improving Query Performance</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/staging3/docs/guides/improving-query-performance/sparse-primary-indexes/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Sparse Primary Indexes</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction-to-skipping-indexes" class="table-of-contents__link toc-highlight">Introduction to Skipping Indexes</a></li><li><a href="#basic-operation" class="table-of-contents__link toc-highlight">Basic Operation</a></li><li><a href="#skip-index-types" class="table-of-contents__link toc-highlight">Skip Index Types</a></li><li><a href="#skip-index-functions" class="table-of-contents__link toc-highlight">Skip Index Functions</a></li><li><a href="#skip-index-settings" class="table-of-contents__link toc-highlight">Skip Index Settings</a></li><li><a href="#skip-best-practices" class="table-of-contents__link toc-highlight">Skip Best Practices</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ClickHouse</div><ul class="footer__items"><li class="footer__item"><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Company</a></li><li class="footer__item"><a href="https://clickhouse.com/cloud/" target="_blank" rel="noopener noreferrer" class="footer__link-item">ClickHouse as a Service</a></li><li class="footer__item"><a href="https://clickhouse.com/careers/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Careers</a></li><li class="footer__item"><a href="https://clickhouse.com/learn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Learn ClickHouse</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ClickHouse/ClickHouse" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://clickhouse.com/blog/en/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/ClickHouseDB" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ClickHouseDB" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/clickhousedb/shared_invite/zt-rxm3rdrk-lIUmhLC3V8WTaL0TGxsOmg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Policies</div><ul class="footer__items"><li class="footer__item"><a href="https://clickhouse.com/legal/trademark-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trademark Policy</a></li><li class="footer__item"><a href="https://clickhouse.com/legal/privacy-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li><li class="footer__item"><a href="https://clickhouse.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/docs/staging3/img/logo.png" alt="ClickHouse Documentation" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/docs/staging3/img/logo.png" alt="ClickHouse Documentation" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></div><div class="footer__copyright">Copyright © 2016 - 2022 ClickHouse, Inc. ClickHouse Docs provided under the Creative Commons CC BY-NC-SA license. ClickHouse is a registered trademark of ClickHouse, Inc.</div></div></div></footer></div>
<script src="/docs/staging3/assets/js/runtime~main.bd77b7df.js"></script>
<script src="/docs/staging3/assets/js/main.78e8e152.js"></script>
</body>
</html>