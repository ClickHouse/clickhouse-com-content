"use strict";(self.webpackChunkclickhouse=self.webpackChunkclickhouse||[]).push([[72464],{3905:function(e,t,a){a.d(t,{Zo:function(){return m},kt:function(){return h}});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},m=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),d=c(a),h=i,p=d["".concat(l,".").concat(h)]||d[h]||u[h]||r;return a?n.createElement(p,s(s({ref:t},m),{},{components:a})):n.createElement(p,s({ref:t},m))}));function h(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,s=new Array(r);s[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:i,s[1]=o;for(var c=2;c<r;c++)s[c]=a[c];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},67625:function(e,t,a){a.r(t),a.d(t,{assets:function(){return m},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return o},metadata:function(){return c},toc:function(){return u}});var n=a(87462),i=a(63366),r=(a(67294),a(3905)),s=["components"],o={sidebar_label:"Sparse Primary Indexes",sidebar_position:20},l="A Practical Introduction to Sparse Primary Indexes in ClickHouse",c={unversionedId:"guides/improving-query-performance/sparse-primary-indexes",id:"guides/improving-query-performance/sparse-primary-indexes",title:"A Practical Introduction to Sparse Primary Indexes in ClickHouse",description:"In this article we are going to do a deep dive into ClickHouse indexing. We will illustrate and discuss in detail:",source:"@site/docs/guides/improving-query-performance/sparse-primary-indexes.md",sourceDirName:"guides/improving-query-performance",slug:"/guides/improving-query-performance/sparse-primary-indexes",permalink:"/docs/staging2/docs/guides/improving-query-performance/sparse-primary-indexes",tags:[],version:"current",sidebarPosition:20,frontMatter:{sidebar_label:"Sparse Primary Indexes",sidebar_position:20},sidebar:"tutorialSidebar",previous:{title:"Data Skipping Indexes",permalink:"/docs/staging2/docs/guides/improving-query-performance/skipping-indexes"},next:{title:"SRE Guides",permalink:"/docs/staging2/docs/guides/sre"}},m={},u=[{value:"Data Set",id:"data-set",level:2},{value:"Test Machine",id:"test-machine",level:2},{value:"A full table scan",id:"a-full-table-scan",level:2},{value:'<a name="original-table"></a>A table with a primary key',id:"a-table-with-a-primary-key",level:2},{value:"An index design for massive data scales",id:"an-index-design-for-massive-data-scales",level:2},{value:'<a name="data-storage"></a>Data is stored on disk ordered by primary key column(s)',id:"data-is-stored-on-disk-ordered-by-primary-key-columns",level:2},{value:'<a name="granules"></a>Data is organized into granules for parallel data processing',id:"data-is-organized-into-granules-for-parallel-data-processing",level:2},{value:'<a name="primary-index"></a>The primary index has one entry per granule',id:"the-primary-index-has-one-entry-per-granule",level:2},{value:"The primary index is used for selecting granules",id:"the-primary-index-is-used-for-selecting-granules",level:2},{value:'<a name="mark-files"></a>Mark files are used for locating granules',id:"mark-files-are-used-for-locating-granules",level:2},{value:'<a name="filtering-on-key-columns-after-the-first"></a>Performance issues when filtering on key columns after the first',id:"performance-issues-when-filtering-on-key-columns-after-the-first",level:2},{value:'<a name="multiple-primary-indexes"></a>Performance tuning with multiple primary indexes',id:"performance-tuning-with-multiple-primary-indexes",level:2},{value:'<a name="multiple-primary-indexes-via-secondary-tables"></a>Multiple primary indexes via secondary tables',id:"multiple-primary-indexes-via-secondary-tables",level:2},{value:"Multiple primary indexes via materialized views",id:"multiple-primary-indexes-via-materialized-views",level:2},{value:"Multiple primary indexes via projections",id:"multiple-primary-indexes-via-projections",level:2},{value:"Removing inefficient key columns",id:"removing-inefficient-key-columns",level:2}],d={toc:u};function h(e){var t=e.components,o=(0,i.Z)(e,s);return(0,r.kt)("wrapper",(0,n.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"a-practical-introduction-to-sparse-primary-indexes-in-clickhouse"},"A Practical Introduction to Sparse Primary Indexes in ClickHouse"),(0,r.kt)("p",null,"In this article we are going to do a deep dive into ClickHouse indexing. We will illustrate and discuss in detail:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"how indexing in ClickHouse is different from traditional relational database management systems"),(0,r.kt)("li",{parentName:"ul"},"how ClickHouse is building and using a table\u2019s sparse primary index"),(0,r.kt)("li",{parentName:"ul"},"what the best practices are for indexing in ClickHouse")),(0,r.kt)("p",null,"You can optionally execute all Clickhouse SQL statements and queries given in this article by yourself on your own machine.\nFor installation of ClickHouse and getting started instructions, see the ",(0,r.kt)("a",{parentName:"p",href:"/docs/staging2/docs/quick-start"},"Quick Start"),"."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"This article is focusing on ClickHouse sparse primary indexes."),(0,r.kt)("p",{parentName:"div"},"For ClickHouse ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#table_engine-mergetree-data_skipping-indexes",target:"_blank"},"secondary data skipping indexes"),", see the ",(0,r.kt)("a",{parentName:"p",href:"/docs/staging2/docs/guides/improving-query-performance/skipping-indexes"},"Tutorial"),". "))),(0,r.kt)("h2",{id:"data-set"},"Data Set"),(0,r.kt)("p",null,"Throughout this article we will use a sample anonymized web traffic data set."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"We will use a subset of 8.87 million rows (events) from the sample data set. "),(0,r.kt)("li",{parentName:"ul"},"The uncompressed data size is 8.87 million events and about 700 MB. This compresses to 200 mb when stored in ClickHouse."),(0,r.kt)("li",{parentName:"ul"},"In our subset, each row contains three columns that indicate an internet user (",(0,r.kt)("inlineCode",{parentName:"li"},"UserID")," column) who clicked on a URL (",(0,r.kt)("inlineCode",{parentName:"li"},"URL")," column) at a specific time (",(0,r.kt)("inlineCode",{parentName:"li"},"EventTime")," column). ")),(0,r.kt)("p",null,"With these three columns we can already formulate some typical web analytics queries such as:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'"What are the top 10 most clicked urls for a specific user?\u201d  '),(0,r.kt)("li",{parentName:"ul"},'"What are the top 10 users that most frequently clicked a specific URL?" '),(0,r.kt)("li",{parentName:"ul"},"\u201cWhat are the most popular times (e.g. days of the week) at which a user clicks on a specific URL?\u201d")),(0,r.kt)("h2",{id:"test-machine"},"Test Machine"),(0,r.kt)("p",null,"All runtime numbers given in this document are based on running ClickHouse 22.2.1 locally on a MacBook Pro with the Apple M1 Pro chip and 16GB of RAM."),(0,r.kt)("h2",{id:"a-full-table-scan"},"A full table scan"),(0,r.kt)("p",null,"In order to see how a query is executed over our data set without a primary key, we create a table (with a MergeTree table engine) by executing the following SQL DDL statement:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE hits_NoPrimaryKey\n(\n    `UserID` UInt32,\n    `URL` String,\n    `EventTime` DateTime\n)\nENGINE = MergeTree\nPRIMARY KEY tuple();\n")),(0,r.kt)("p",null,"Next insert a subset of the hits data set into the table with the following SQL insert statement. This uses the ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/sql-reference/table-functions/url/",target:"_blank"},"URL table function")," in combination with ",(0,r.kt)("a",{href:"https://clickhouse.com/blog/whats-new-in-clickhouse-22-1/#schema-inference",target:"_blank"},"schema inference")," in order to load a  subset of the full dataset hosted remotely at clickhouse.com:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO hits_NoPrimaryKey SELECT\n   intHash32(c11::UInt64) AS UserID,\n   c15 AS URL,\n   c5 AS EventTime\nFROM url('https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz')\nWHERE URL != '';\n")),(0,r.kt)("p",null,"The response is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"Ok.\n\n0 rows in set. Elapsed: 145.993 sec. Processed 8.87 million rows, 18.40 GB (60.78 thousand rows/s., 126.06 MB/s.)\n")),(0,r.kt)("p",null,"ClickHouse client\u2019s result output shows us that the statement above inserted 8.87 million rows into the table."),(0,r.kt)("p",null,"Lastly, in order to simplify the discussions later on in this article and to make the diagrams and results reproducible, we ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/sql-reference/statements/optimize/",target:"_blank"},"optimize")," the table using the FINAL keyword:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"OPTIMIZE TABLE hits_NoPrimaryKey FINAL;\n")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"In general it is not required nor recommended to immediately optimize a table\nafter loading data into it. Why this is necessary for this example will become apparent."))),(0,r.kt)("p",null,"Now we execute our first web analytics query. The following is calculating the top 10 most clicked urls for the internet user with the UserID 749927693:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT URL, count(URL) as Count\nFROM hits_NoPrimaryKey\nWHERE UserID = 749927693\nGROUP BY URL\nORDER BY Count DESC\nLIMIT 10;\n")),(0,r.kt)("p",null,"The response is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500URL\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500Count\u2500\u2510\n\u2502 http://auto.ru/chatay-barana.. \u2502   170 \u2502\n\u2502 http://auto.ru/chatay-id=371...\u2502    52 \u2502\n\u2502 http://public_search           \u2502    45 \u2502\n\u2502 http://kovrik-medvedevushku-...\u2502    36 \u2502\n\u2502 http://forumal                 \u2502    33 \u2502\n\u2502 http://korablitz.ru/L_1OFFER...\u2502    14 \u2502\n\u2502 http://auto.ru/chatay-id=371...\u2502    14 \u2502\n\u2502 http://auto.ru/chatay-john-D...\u2502    13 \u2502\n\u2502 http://auto.ru/chatay-john-D...\u2502    10 \u2502\n\u2502 http://wot/html?page/23600_m...\u2502     9 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n10 rows in set. Elapsed: 0.022 sec.\n// highlight-next-line \nProcessed 8.87 million rows, \n70.45 MB (398.53 million rows/s., 3.17 GB/s.)\n")),(0,r.kt)("p",null,"ClickHouse client\u2019s result output indicates that ClickHouse executed a full table scan! Each single row of the 8.87 million rows of our table was streamed into ClickHouse. That doesn\u2019t scale."),(0,r.kt)("p",null,"To make this (way) more efficient and (much) faster, we need to use a table with a appropriate primary key. This will allow ClickHouse to automatically (based on the primary key\u2019s column(s)) create a sparse primary index which can then be used to significantly speed up the execution of our example query."),(0,r.kt)("h2",{id:"a-table-with-a-primary-key"},(0,r.kt)("a",{name:"original-table"}),"A table with a primary key"),(0,r.kt)("p",null,"Create a table that has a compound primary key with key columns UserID and URL: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE hits_UserID_URL\n(\n    `UserID` UInt32,\n    `URL` String,\n    `EventTime` DateTime\n)\nENGINE = MergeTree\n// highlight-next-line    \nPRIMARY KEY (UserID, URL)\nORDER BY (UserID, URL, EventTime)\nSETTINGS index_granularity = 8192, index_granularity_bytes = 0;\n")),(0,r.kt)("details",null,(0,r.kt)("summary",null,(0,r.kt)("font",{color:"black"},"DDL Statement Details")),(0,r.kt)("p",null,(0,r.kt)("font",{color:"black"},(0,r.kt)("p",null,"In order to simplify the discussions later on in this article, as well as  make the diagrams and results reproducible, the DDL statement"),(0,r.kt)("ul",null,(0,r.kt)("li",null,"specifies a compound sorting key for the table via an ",(0,r.kt)("font",{face:"monospace"},"ORDER BY")," clause"),(0,r.kt)("br",null),(0,r.kt)("li",null,"explicitly controls how many index entries the primary index will have through the settings:"),(0,r.kt)("br",null),(0,r.kt)("ul",null,(0,r.kt)("li",null,(0,r.kt)("font",{face:"monospace"},"index_granularity"),": explicitly set to its default value of 8192. This means that for each group of 8192 rows, the primary index will have one index entry, e.g. if the table contains 16384 rows then the index will have two index entries."),(0,r.kt)("br",null),(0,r.kt)("li",null,(0,r.kt)("font",{face:"monospace"},"index_granularity_bytes"),": set to 0 in order to disable ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/whats-new/changelog/2019/#experimental-features-1",target:"_blank"},(0,r.kt)("font",{color:"blue"},"adaptive index granularity")),". Adaptive index granularity means that ClickHouse automatically creates one index entry for a group of n rows",(0,r.kt)("ul",null,(0,r.kt)("li",null,"if either n is less than 8192 but the size of the combined row data for that n rows is larger than or equal 10 MB (the default value for index_granularity_bytes) or"),(0,r.kt)("li",null,"if the combined row data size for n rows is less than 10 MB but n is 8192.")))))))),(0,r.kt)("p",null,"The primary key in the DDL statement above causes the creation of primary index based on the two specified key columns."),(0,r.kt)("br",null),"Next insert the data:",(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO hits_UserID_URL SELECT\n   intHash32(c11::UInt64) AS UserID,\n   c15 AS URL,\n   c5 AS EventTime\nFROM url('https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz')\nWHERE URL != '';\n")),(0,r.kt)("p",null,"The response looks like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"0 rows in set. Elapsed: 149.432 sec. Processed 8.87 million rows, 18.40 GB (59.38 thousand rows/s., 123.16 MB/s.)\n")),(0,r.kt)("br",null),"And optimize the table:",(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"OPTIMIZE TABLE hits_UserID_URL FINAL;\n")),(0,r.kt)("br",null),"We can use the following query to obtain metadata about our table:",(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    part_type,\n    path,\n    formatReadableQuantity(rows) AS rows,\n    formatReadableSize(data_uncompressed_bytes) AS data_uncompressed_bytes,\n    formatReadableSize(data_compressed_bytes) AS data_compressed_bytes,\n    formatReadableSize(primary_key_bytes_in_memory) AS primary_key_bytes_in_memory,\n    marks,\n    formatReadableSize(bytes_on_disk) AS bytes_on_disk\nFROM system.parts\nWHERE (table = 'hits_UserID_URL') AND (active = 1)\nFORMAT Vertical;\n")),(0,r.kt)("p",null,"The response is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"part_type:                   Wide\npath:                        ./store/d9f/d9f36a1a-d2e6-46d4-8fb5-ffe9ad0d5aed/all_1_9_2/\nrows:                        8.87 million\ndata_uncompressed_bytes:     733.28 MiB\ndata_compressed_bytes:       206.94 MiB\nprimary_key_bytes_in_memory: 96.93 KiB\nmarks:                       1083\nbytes_on_disk:               207.07 MiB\n\n\n1 rows in set. Elapsed: 0.003 sec.\n")),(0,r.kt)("p",null,"The output of the ClickHouse client shows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The table\u2019s data is stored in ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#mergetree-data-storage",target:"_blank"},"wide format")," in a specific directory on disk meaning that there will be one data file (and one mark file) per table column inside that directory."),(0,r.kt)("li",{parentName:"ul"},"The table has 8.87 million rows."),(0,r.kt)("li",{parentName:"ul"},"The uncompressed data size of all rows together is 733.28 MB."),(0,r.kt)("li",{parentName:"ul"},"The compressed on disk data size of all rows together is 206.94 MB."),(0,r.kt)("li",{parentName:"ul"},"The table has a primary index with 1083 entries (called \u2018marks\u2019) and the size of the index is 96.93 KB."),(0,r.kt)("li",{parentName:"ul"},"In total the table\u2019s data and mark files and primary index file together take 207.07 MB on disk.")),(0,r.kt)("h2",{id:"an-index-design-for-massive-data-scales"},"An index design for massive data scales"),(0,r.kt)("p",null,"In traditional relational database management systems the primary index would contain one entry per table row. For our data set this would result in the  primary index - often a ",(0,r.kt)("a",{href:"https://en.wikipedia.org/wiki/B%2B_tree",target:"_blank"},"B(+)-Tree")," data structure - containing 8.87 million entries. "),(0,r.kt)("p",null,"Such an index allows the fast location of specific rows, resulting in high efficiency for lookup queries and point updates. Searching an entry in a B(+)-Tree data structure has average time complexity of ",(0,r.kt)("font",{face:"monospace"},"O(log2 n)"),". For a table of 8.87 million rows this means 23 steps are required to locate any index entry."),(0,r.kt)("p",null,"This capability comes at a cost: additional disk and memory overheads and higher insertion costs when adding new rows to to the table and entries to the index (and also sometimes rebalancing of the B-Tree)."),(0,r.kt)("p",null,"Considering the challenges associated with B-Tee indexes, table engines in ClickHouse utilise a different approach. The ClickHouse ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/",target:"_blank"},"MergeTree Engine Family")," has been designed and  optimized to handle massive data volumes."),(0,r.kt)("p",null,"These tables are designed to receive  millions of row inserts per second and store very large (100s of Petabytes) volumes of data."),(0,r.kt)("p",null,"Data is quickly written to a table ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#mergetree-data-storage",target:"_blank"},"part by part"),", with rules applied for merging the parts in the background. "),(0,r.kt)("p",null,"In ClickHouse each part has its own primary index. When parts are merged then also the merged part\u2019s primary indexes are merged. "),(0,r.kt)("p",null,"At the very large scale that ClickHouse is designed for, it is paramount to be very disk and memory efficient. Therefore, instead of indexing every row, the primary index for a part has one index entry (known as a \u2018mark\u2019) per group of rows (called \u2018granule\u2019). "),(0,r.kt)("p",null,"This sparse indexing is possible because ClickHouse is storing the rows for a part on disk ordered by the primary key column(s). "),(0,r.kt)("p",null,"Instead of directly locating single rows (like a B-Tree based index), the sparse primary index allows it to quickly (via a binary search over index entries) identify groups of rows that could possibly match the query. "),(0,r.kt)("p",null,"The located groups of potentially matching rows (granules) are then in parallel streamed into the ClickHouse engine in order to find the matches."),(0,r.kt)("p",null,"This index design allows for the primary index to be small (it can and must completely fit into the main memory), whilst still significantly speeding up query execution times: especially for range queries that are typical in data analytics use cases."),(0,r.kt)("p",null,"The following illustrates in detail how ClickHouse is building and using its sparse primary index.\nLater on in the article we will discuss some best practices for choosing, removing, and ordering the table columns that are used to build the index (primary key columns)."),(0,r.kt)("h2",{id:"data-is-stored-on-disk-ordered-by-primary-key-columns"},(0,r.kt)("a",{name:"data-storage"}),"Data is stored on disk ordered by primary key column(s)"),(0,r.kt)("p",null,"Our table that we created above has "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"a compound ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#primary-keys-and-indexes-in-queries",target:"_blank"},"primary key")," ",(0,r.kt)("font",{face:"monospace"},"(UserID, URL)")," and "),(0,r.kt)("li",{parentName:"ul"},"a compound ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#choosing-a-primary-key-that-differs-from-the-sorting-key",target:"_blank"},"sorting key")," ",(0,r.kt)("font",{face:"monospace"},"(UserID, URL, EventTime)"),". ")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"The primary key needs to be a prefix of the sorting key if both are specified."))),(0,r.kt)("p",null,"The inserted rows are stored on disk in lexicographical order (ascending) by the primary key columns. "),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"ClickHouse allows inserting multiple rows with identical primary key column values. In this case (see row 1 and row 2 in the diagram below), the final order is determined by the specified sorting key and therefore the value of the ",(0,r.kt)("font",{face:"monospace"},"EventTime")," column."))),(0,r.kt)("p",null,"ClickHouse is a ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/introduction/distinctive-features/#true-column-oriented-dbms\n",target:"_blank"},"column-oriented database management system"),". As show in the diagram below"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"for the on disk representation, there is a single data file (*.bin) per table column where all the values for that column are stored in a ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/introduction/distinctive-features/#data-compression",target:"_blank"},"compressed")," format, and"),(0,r.kt)("li",{parentName:"ul"},"the 8.87 million rows are stored on disk in lexicographic ascending order by the primary key columns (and sort key columns) i.e. in this case",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"first by ",(0,r.kt)("font",{face:"monospace"},"UserID"),", "),(0,r.kt)("li",{parentName:"ul"},"then by ",(0,r.kt)("font",{face:"monospace"},"URL"),", "),(0,r.kt)("li",{parentName:"ul"},"and lastly by ",(0,r.kt)("font",{face:"monospace"},"EventTime"),":")))),(0,r.kt)("img",{src:a(48430).Z,class:"image"}),"UserID.bin, URL.bin, and EventTime.bin are the data files on disk where the values of the ",(0,r.kt)("font",{face:"monospace"},"UserID"),", ",(0,r.kt)("font",{face:"monospace"},"URL"),", and ",(0,r.kt)("font",{face:"monospace"},"EventTime")," columns are stored.",(0,r.kt)("br",null),(0,r.kt)("br",null),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("ul",{parentName:"div"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"As the primary key defines the lexicographical order of the rows on disk, a table can only have one primary key.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"We are numbering rows starting with 0 in order to be aligned with the ClickHouse internal row numbering scheme that is also used for logging messages."))))),(0,r.kt)("h2",{id:"data-is-organized-into-granules-for-parallel-data-processing"},(0,r.kt)("a",{name:"granules"}),"Data is organized into granules for parallel data processing"),(0,r.kt)("p",null,"For data processing purposes, a table's column values are logically divided into granules.\nA granule is the smallest indivisible data set that is streamed into ClickHouse for data processing.\nThis means that instead of reading individual rows, ClickHouse is always reading (in a streaming fashion and in parallel) a whole group (granule) of rows."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Column values are not physically stored inside granules: granules are just a logical organization of the column values for query processing."))),(0,r.kt)("p",null,"The following diagram shows how the (column values of) 8.87 million rows of our table\nare organized into 1083 granules, as a result of the table's DDL statement containing the setting ",(0,r.kt)("font",{face:"monospace"},"index_granularity")," (set to its default value of 8192). "),(0,r.kt)("img",{src:a(60418).Z,class:"image"}),(0,r.kt)("p",null,"The first (based on physical order on disk) 8192 rows (their column values) logically belong to granule 0, then the next 8192 rows (their column values) belong to granule 1 and so on. "),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("ul",{parentName:"div"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},'The last granule (granule 1082) "contains" less than 8192 rows.')),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"We marked some column values from our primary key columns (",(0,r.kt)("font",{face:"monospace"},"UserID"),", ",(0,r.kt)("font",{face:"monospace"},"URL"),") in orange. "),(0,r.kt)("p",{parentName:"li"},"These orange marked column values are the minimum value of each primary key column in each granule. The exception here is the last granule (granule 1082 in the diagram above) where we mark the maximum values. "),(0,r.kt)("p",{parentName:"li"},"As we will see below, these orange marked column values will be the entries in the table's primary index.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"We are numbering granules starting with 0 in order to be aligned with the ClickHouse internal numbering scheme that is also used for logging messages."))))),(0,r.kt)("h2",{id:"the-primary-index-has-one-entry-per-granule"},(0,r.kt)("a",{name:"primary-index"}),"The primary index has one entry per granule"),(0,r.kt)("p",null,"The primary index is created based on the granules shown in the diagram above. This index is an uncompressed flat array file (primary.idx), containing so-called numerical index marks starting at 0."),(0,r.kt)("p",null,"The diagram below shows that the index stores the minimum primary key column values (the values marked in orange in the diagram above) for each granule.\nFor example"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"the first index entry (\u2018mark 0\u2019 in the diagram below) is storing the minimum values for the primary key columns of granule 0 from the diagram above,  "),(0,r.kt)("li",{parentName:"ul"},"the second index entry (\u2018mark 1\u2019 in the diagram below) is storing the minimum values for the primary key columns of granule 1 from the diagram above, and so on. ")),(0,r.kt)("img",{src:a(90179).Z,class:"image"}),(0,r.kt)("p",null,"In total the index has 1083 entries for our table with 8.87 million rows and 1083 granules: "),(0,r.kt)("img",{src:a(4918).Z,class:"image"}),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("ul",{parentName:"div"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The last index entry (\u2018mark 1082\u2019 in the diagram below) is storing the maximum values for the primary key columns of granule 1082 from the diagram above.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Index entries (index marks) are not based on specific rows from our table but on granules. E.g. for index entry \u2018mark 0\u2019 in the diagram above there is no row in our table where ",(0,r.kt)("font",{face:"monospace"},"UserID")," is ",(0,r.kt)("font",{face:"monospace"},"240.923")," and ",(0,r.kt)("font",{face:"monospace"},"URL")," is ",(0,r.kt)("font",{face:"monospace"},'"goal://metry=10000467796a411..."'),", instead, there is a granule 0 for the table where within that granule the minimum UserID vale is ",(0,r.kt)("font",{face:"monospace"},"240.923")," and the minimum URL value is ",(0,r.kt)("font",{face:"monospace"},'"goal://metry=10000467796a411..."')," and these two values are from separate rows."))))),(0,r.kt)("p",null,"The primary key entries are called index marks because each index entry is marking the start of a specific data range. Specifically for the example table:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"UserID index marks:",(0,r.kt)("br",null),"\nThe stored ",(0,r.kt)("font",{face:"monospace"},"UserID")," values in the primary index are sorted in ascending order.",(0,r.kt)("br",null),"\n\u2018mark 1\u2019 in the diagram above thus indicates that the ",(0,r.kt)("font",{face:"monospace"},"UserID")," values of all table rows in granule 1, and in all following granules, are guaranteed to be greater than or equal to 4.073.710."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"#query-on-userid-fast"},"As we will see later"),", this global order enables ClickHouse to ",(0,r.kt)("a",{href:"https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452",target:"_blank"},"use a binary search algorithm")," over the index marks for the first key column when a query is filtering on the first column of the primary key.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"URL index marks:",(0,r.kt)("br",null),"\nThe quite similar cardinality of the primary key columns ",(0,r.kt)("font",{face:"monospace"},"UserID")," and ",(0,r.kt)("font",{face:"monospace"},"URL")," means that the index marks for all key columns after the first column in general only indicate a data range per granule.",(0,r.kt)("br",null),"\nFor example, \u2018mark 0\u2019 for the ",(0,r.kt)("font",{face:"monospace"},"URL")," column in the diagram above is indicating that the URL values of all table rows in granule 0 are guaranteed to be larger or equal to ",(0,r.kt)("font",{face:"monospace"},"goal://metry=10000467796a411..."),". However, this same guarantee cannot also be given for the ",(0,r.kt)("font",{face:"monospace"},"URL")," values of all table rows in granule 1  because \u2018mark 1\u2018 for the ",(0,r.kt)("font",{face:"monospace"},"UserID")," column has a different UserID value than \u2018mark 0\u2018. "),(0,r.kt)("p",{parentName:"li"}," We will discuss the consequences of this on query execution performance in more detail later."))),(0,r.kt)("h2",{id:"the-primary-index-is-used-for-selecting-granules"},"The primary index is used for selecting granules"),(0,r.kt)("p",null,"We can now execute our queries with support from the primary index."),(0,r.kt)("a",{name:"query-on-userid"}),"The following calculates the top 10 most clicked urls for the UserID 749927693.",(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT URL, count(URL) AS Count\nFROM hits_UserID_URL\nWHERE UserID = 749927693\nGROUP BY URL\nORDER BY Count DESC\nLIMIT 10;\n")),(0,r.kt)("p",null,"The response is:"),(0,r.kt)("a",{name:"query-on-userid-fast"}),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500URL\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500Count\u2500\u2510\n\u2502 http://auto.ru/chatay-barana.. \u2502   170 \u2502\n\u2502 http://auto.ru/chatay-id=371...\u2502    52 \u2502\n\u2502 http://public_search           \u2502    45 \u2502\n\u2502 http://kovrik-medvedevushku-...\u2502    36 \u2502\n\u2502 http://forumal                 \u2502    33 \u2502\n\u2502 http://korablitz.ru/L_1OFFER...\u2502    14 \u2502\n\u2502 http://auto.ru/chatay-id=371...\u2502    14 \u2502\n\u2502 http://auto.ru/chatay-john-D...\u2502    13 \u2502\n\u2502 http://auto.ru/chatay-john-D...\u2502    10 \u2502\n\u2502 http://wot/html?page/23600_m...\u2502     9 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n10 rows in set. Elapsed: 0.005 sec.\n// highlight-next-line  \nProcessed 8.19 thousand rows, \n740.18 KB (1.53 million rows/s., 138.59 MB/s.)\n")),(0,r.kt)("p",null,"The output for the ClickHouse client is now showing that instead of doing a full table scan, only 8.19 thousand rows were streamed into ClickHouse. "),(0,r.kt)("p",null,"If ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-logger",target:"_blank"},"trace logging")," is enabled then the ClickHouse server log file shows that ClickHouse was running a ",(0,r.kt)("a",{href:"https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452",target:"_blank"},"binary search")," over the 1083 UserID index marks, in order to identify granules that possibly can contain rows with a UserID column value of ",(0,r.kt)("font",{face:"monospace"},"749927693"),". This requires 19 steps with an average time complexity of ",(0,r.kt)("font",{face:"monospace"},"O(log2 n)"),": "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"...Executor): Key condition: (column 0 in [749927693, 749927693])\n// highlight-next-line \n...Executor): Running binary search on index range for part all_1_9_2 (1083 marks)\n...Executor): Found (LEFT) boundary mark: 176\n...Executor): Found (RIGHT) boundary mark: 177\n...Executor): Found continuous range in 19 steps\n...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,\n// highlight-next-line  \n              1/1083 marks by primary key, 1 marks to read from 1 ranges\n...Reading ...approx. 8192 rows starting from 1441792\n")),(0,r.kt)("p",null,"We can see in the trace log above, that one mark out of the 1083 existing marks satisfied the query. "),(0,r.kt)("details",null,(0,r.kt)("summary",null,(0,r.kt)("font",{color:"black"},"Trace Log Details")),(0,r.kt)("p",null,(0,r.kt)("font",{color:"black"},(0,r.kt)("p",null,"Mark 176 was identified (the 'found left boundary mark' is inclusive, the 'found right boundary mark' is exclusive), and therefore all 8192 rows from granule 176 (which starts at row 1.441.792 - we will see that later on in this article) are then streamed into ClickHouse in order to find the actual rows with a UserID column value of ",(0,r.kt)("font",{face:"monospace"},"749927693"),". ")))),(0,r.kt)("p",null,"We can also reproduce this by using the ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/sql-reference/statements/explain/",target:"_blank"},"EXPLAIN clause")," in our example query:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"EXPLAIN indexes = 1\nSELECT URL, count(URL) AS Count\nFROM hits_UserID_URL\nWHERE UserID = 749927693\nGROUP BY URL\nORDER BY Count DESC\nLIMIT 10;\n")),(0,r.kt)("p",null,"The response looks like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500explain\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Expression (Projection)                                                               \u2502\n\u2502   Limit (preliminary LIMIT (without OFFSET))                                          \u2502\n\u2502     Sorting (Sorting for ORDER BY)                                                    \u2502\n\u2502       Expression (Before ORDER BY)                                                    \u2502\n\u2502         Aggregating                                                                   \u2502\n\u2502           Expression (Before GROUP BY)                                                \u2502\n\u2502             Filter (WHERE)                                                            \u2502\n\u2502               SettingQuotaAndLimits (Set limits and quota after reading from storage) \u2502\n\u2502                 ReadFromMergeTree                                                     \u2502\n\u2502                 Indexes:                                                              \u2502\n\u2502                   PrimaryKey                                                          \u2502\n\u2502                     Keys:                                                             \u2502\n\u2502                       UserID                                                          \u2502\n\u2502                     Condition: (UserID in [749927693, 749927693])                     \u2502\n\u2502                     Parts: 1/1                                                        \u2502\n// highlight-next-line\n\u2502                     Granules: 1/1083                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n16 rows in set. Elapsed: 0.003 sec.\n")),(0,r.kt)("p",null,"The client output is showing that one out of the 1083 granules was selected as possibly containing rows with a UserID column value of 749927693. "),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Conclusion")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"When a query is filtering on a column that is part of a compound key and is the first key column, then ClickHouse is running the binary search algorithm over the key column's index marks."))),(0,r.kt)("br",null),(0,r.kt)("p",null,"As discussed above, ClickHouse is using its sparse primary index for quickly (via binary search) selecting granules that could possibly contain rows that match a query. "),(0,r.kt)("p",null,"This is the ",(0,r.kt)("strong",{parentName:"p"},"first stage (granule selection)")," of ClickHouse query execution."),(0,r.kt)("p",null,"In the ",(0,r.kt)("strong",{parentName:"p"},"second stage (data reading)"),", ClickHouse is locating the selected granules in order to stream all their rows into the ClickHouse engine in order to find the rows that are actually matching the query. "),(0,r.kt)("p",null,"We discuss that second stage in more detail in the following section.  "),(0,r.kt)("h2",{id:"mark-files-are-used-for-locating-granules"},(0,r.kt)("a",{name:"mark-files"}),"Mark files are used for locating granules"),(0,r.kt)("p",null,"The following diagram illustrates a part of the primary index file for our table. "),(0,r.kt)("img",{src:a(26391).Z,class:"image"}),(0,r.kt)("p",null,"As discussed above, via a binary search over the index\u2019s 1083 UserID marks, mark 176 were identified. Its corresponding granule 176 can therefore possibly contain rows with a UserID column value of 749.927.693."),(0,r.kt)("details",null,(0,r.kt)("summary",null,(0,r.kt)("font",{color:"black"},"Granule Selection Details")),(0,r.kt)("p",null,(0,r.kt)("font",{color:"black"},(0,r.kt)("p",null,"The diagram above shows that mark 176 is the first index entry where both the minimum UserID value of the associated granule 176 is smaller than 749.927.693, and the minimum UserID value of granule 177 for the next mark (mark 177) is greater than this value. Therefore only the corresponding granule 176 for mark 176 can possibly contain rows with a UserID column value of 749.927.693.")))),(0,r.kt)("p",null,"In order to confirm (or not) that some row(s) in granule 176 contain a UserID column value of 749.927.693, all 8192 rows belonging to this granule need to be streamed into ClickHouse. "),(0,r.kt)("p",null,"To achieve this, ClickHouse needs to know the physical location of granule 176."),(0,r.kt)("p",null,"In ClickHouse the physical locations of all granules for our table are stored in mark files. Similar to data files, there is one mark file per table column. "),(0,r.kt)("p",null,"The following diagram shows the three mark files UserID.mrk, URL.mrk, and EventTime.mrk that store the physical locations of the granules for the table\u2019s UserID, URL, and EventTime columns."),(0,r.kt)("img",{src:a(60044).Z,class:"image"}),(0,r.kt)("p",null,"We have discussed how the primary index is a flat uncompressed array file (primary.idx), containing index marks that are numbered starting at 0.  "),(0,r.kt)("p",null,"Similarily, a mark file is also a flat uncompressed array file (*.mrk) containing marks that are numbered starting at 0."),(0,r.kt)("p",null,"Once ClickHouse has identified and selected the index mark for a granule that can possibly contain matching rows for a query, a positional array lookup can be performed in the mark files in order to obtain the physical locations of the granule."),(0,r.kt)("p",null,"Each mark file entry for a specific column is storing two locations in the form of offsets: "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The first offset ('block_offset' in the diagram above) is locating the ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/development/architecture/#block",target:"_blank"},"block")," in the ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/introduction/distinctive-features/#data-compression",target:"_blank"},"compressed")," column data file that contains the compressed version of the selected granule. This compressed block potentially contains a few compressed granules. The located compressed file block is uncompressed into the main memory on read. ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The second offset ('granule_offset' in the diagram above) from the mark-file provides the location of the  granule within the uncompressed block data."))),(0,r.kt)("p",null,"All the 8192 rows belonging to the located uncompressed granule are then streamed into ClickHouse for further processing."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Why Mark Files")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Why does the primary index not directly contain the physical locations of the granules that are corresponding to index marks? "),(0,r.kt)("p",{parentName:"div"},"Because at that very large scale that ClickHouse is designed for, it is important to be very disk and memory efficient."),(0,r.kt)("p",{parentName:"div"},"The primary index file needs to fit into the main memory. "),(0,r.kt)("p",{parentName:"div"},"For our example query ClickHouse used the primary index and selected a single granule that can possibly contain rows matching our query. Only for that one granule does ClickHouse then need the physical locations in order to stream the corresponding rows for further processing. "),(0,r.kt)("p",{parentName:"div"},"Furthermore, this offset information is only needed for the UserID and URL columns. "),(0,r.kt)("p",{parentName:"div"},"Offset information is not needed for columns that are not used in the query e.g. the EventTime."),(0,r.kt)("p",{parentName:"div"},"For our sample query, Clickhouse needs only the two physical location offsets for granule 176 in the UserID data file (UserID.bin) and the two physical location offsets for granule 176 in the URL data file (URL.data). "),(0,r.kt)("p",{parentName:"div"},"The indirection provided by mark files avoids storing, directly within the primary index, entries for the physical locations of all 1083 granules for all three columns: thus avoiding having unnecessary (potentially unused) data in main memory."))),(0,r.kt)("p",null,"The following diagram and the text below illustrates how for our example query ClickHouse locates granule 176 in the UserID.bin data file."),(0,r.kt)("img",{src:a(7205).Z,class:"image"}),(0,r.kt)("p",null,"We discussed earlier in this article that ClickHouse selected the primary index mark 176 and therefore granule 176 as possibly containing matching rows for our query. "),(0,r.kt)("p",null,"ClickHouse now uses the selected mark number (176) from the index for a positional array lookup in the UserID.mrk mark file in order to get the two offsets for locating granule 176. "),(0,r.kt)("p",null,"As shown, the first offset is locating the compressed file block within the UserID.bin data file that in turn contains the compressed version of granule 176."),(0,r.kt)("p",null,"Once the located file block is uncompressed into the main memory, the second offset from the mark file can be used to locate granule 176 within the uncompressed data.  "),(0,r.kt)("p",null,"ClickHouse needs to locate (and stream all values from) granule 176 from both the UserID.bin data file and the URL.bin data file in order to execute our example query (top 10 most clicked urls for the internet user with the UserID 749.927.693). "),(0,r.kt)("p",null,"The diagram above shows how ClickHouse is locating the granule for the UserID.bin data file. "),(0,r.kt)("p",null,"In parallel, ClickHouse is doing the same for granule 176 for the URL.bin data file. The two respective granules are aligned and streamed into the ClickHouse engine for further processing i.e. aggregating and counting the URL values per group for all rows where the UserID is 749.927.693, before finally outputting the 10 largest URL groups in descending count order."),(0,r.kt)("h2",{id:"performance-issues-when-filtering-on-key-columns-after-the-first"},(0,r.kt)("a",{name:"filtering-on-key-columns-after-the-first"}),"Performance issues when filtering on key columns after the first"),(0,r.kt)("p",null,"When a query is filtering on a column that is part of a compound key and is the first key column, then ClickHouse is running the binary search algorithm over the key column's index marks."),(0,r.kt)("p",null,"But what happens when a query is filtering on a column that is part of a compound key, but is not the first key column? "),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"We discuss a scenario when a query is explicitly not filtering on the first key colum, but on any key column after the first. "),(0,r.kt)("p",{parentName:"div"},"When a query is filtering on both the first key column and on any key column(s) after the first then ClickHouse is running binary search over the first key column's index marks.  "))),(0,r.kt)("br",null),(0,r.kt)("br",null),(0,r.kt)("a",{name:"query-on-url"}),'We use a query that calculates the top 10 users that have most frequently clicked on the URL "http://public_search":',(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT UserID, count(UserID) AS Count\nFROM hits_UserID_URL\nWHERE URL = 'http://public_search'\nGROUP BY UserID\nORDER BY Count DESC\nLIMIT 10;\n")),(0,r.kt)("p",null,"The response is: ",(0,r.kt)("a",{name:"query-on-url-slow"})),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500\u2500\u2500\u2500\u2500UserID\u2500\u252c\u2500Count\u2500\u2510\n\u2502 2459550954 \u2502  3741 \u2502\n\u2502 1084649151 \u2502  2484 \u2502\n\u2502  723361875 \u2502   729 \u2502\n\u2502 3087145896 \u2502   695 \u2502\n\u2502 2754931092 \u2502   672 \u2502\n\u2502 1509037307 \u2502   582 \u2502\n\u2502 3085460200 \u2502   573 \u2502\n\u2502 2454360090 \u2502   556 \u2502\n\u2502 3884990840 \u2502   539 \u2502\n\u2502  765730816 \u2502   536 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n10 rows in set. Elapsed: 0.086 sec.\n// highlight-next-line  \nProcessed 8.81 million rows, \n799.69 MB (102.11 million rows/s., 9.27 GB/s.)\n")),(0,r.kt)("p",null,"The client output indicates that ClickHouse almost executed a full table scan despite the URL column being part of the compound primary key! ClickHouse reads 8.81 million rows from the 8.87 million rows of the table."),(0,r.kt)("p",null,"If ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-logger",target:"_blank"},"trace logging")," is enabled then the ClickHouse server log file shows that ClickHouse used a ",(0,r.kt)("a",{href:"https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1444",target:"_blank"},"generic exclusion search"),' over the 1083 URL index marks in order to identify those granules that possibly can contain rows with a URL column value of "http://public_search":'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"...Executor): Key condition: (column 1 in ['http://public_search', \n                                           'http://public_search'])\n// highlight-next-line \n...Executor): Used generic exclusion search over index for part all_1_9_2 \n              with 1537 steps\n...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,\n// highlight-next-line \n              1076/1083 marks by primary key, 1076 marks to read from 5 ranges\n...Executor): Reading approx. 8814592 rows with 10 streams\n")),(0,r.kt)("p",null,"We can see in the sample trace log above, that 1076 (via the marks) out of 1083 granules were selected as possibly containing rows with a matching URL value.  "),(0,r.kt)("p",null,'This results in 8.81 million rows being streamed into the ClickHouse engine (in parallel by using 10 streams), in order to identify the rows that are actually contain the URL value "http://public_search".'),(0,r.kt)("p",null,"However, ",(0,r.kt)("a",{parentName:"p",href:"#query-on-url-fast"},"as we will see later")," only 39 granules out of that selected 1076 granules actually contain matching rows."),(0,r.kt)("p",null,"Whilst the primary index based on the compound primary key (UserID, URL) was very useful for speeding up queries filtering for rows with a specific UserID value, the index is not providing significant help with speeding up the query that filters for rows with a specific URL value. "),(0,r.kt)("p",null,"The reason for this is that the URL column is not the first key column and therefore ClickHouse is using a generic exclusion search algorithm (instead of binary search) over the URL column's index marks, and ",(0,r.kt)("strong",{parentName:"p"},"the effectiveness of that algorithm is dependant on the cardinality difference")," between the URL column and it's predecessor key column UserID."),(0,r.kt)("p",null,"In order to illustrate that, we give some details about how the generic exclusion search works."),(0,r.kt)("details",{open:!0},(0,r.kt)("summary",null,(0,r.kt)("font",{color:"black"},(0,r.kt)("a",{name:"generic-exclusion-search-algorithm"}),"Generic exclusion search algorithm details")),(0,r.kt)("p",null,(0,r.kt)("font",{color:"black"},(0,r.kt)("p",null,"The following is illustrating how the ",(0,r.kt)("a",{href:"https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L14444",target:"_blank"},(0,r.kt)("font",{color:"blue"},"ClickHouse generic exclusion search algorithm"))," works when granules are selected via any column after the first, when the predecessor key column has a low(er) or high(er) cardinality."),(0,r.kt)("p",null,"As an example for both cases we will assume:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'a query that is searching for rows with URL value = "W3".'),(0,r.kt)("li",{parentName:"ul"},"an abstract version of our hits table with simplified values for UserID and URL."),(0,r.kt)("li",{parentName:"ul"},"the same compound primary key (UserID, URL) for the index. This means rows are first ordered by UserID values. Rows with the same UserID value are then ordered by URL."),(0,r.kt)("li",{parentName:"ul"},"a granule size of two i.e. each granule contains two rows.")),(0,r.kt)("p",null,"We have marked the minimum key column values for each granule in orange in the diagrams below.."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Predecessor key column has low(er) cardinality"),(0,r.kt)("a",{name:"generic-exclusion-search-fast"})),(0,r.kt)("p",null,"Suppose UserID had low cardinality. In this case it would be likely that the same UserID value is spread over multiple table rows and granules and therefore index marks. For index marks with the same UserID, the URL values for the index marks are sorted in ascending order (because the table rows are ordered first by UserID and then by URL). This allows efficient filtering as described below:"),(0,r.kt)("img",{src:a(16861).Z,class:"image"}),(0,r.kt)("p",null,"There are three different scenarios for the granule selection process for our abstract sample data in the diagram above:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Index mark 0 for which the (minimum) ",(0,r.kt)("strong",{parentName:"p"},"URL value is smaller than W3 and for which the URL value of the directly succeeding index mark is also smaller than W3")," can be excluded because mark 0, 1, and 2 have the same UserID value. Note that this exclusion-precondition ensures that granule 0 and the next granule 1 are completely composed of U1 UserID values so that ClickHouse can assume that also the maximum URL value in granule 0 is smaller than W3 and exclude the granule.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Index mark 1 for which the ",(0,r.kt)("strong",{parentName:"p"},"URL value is smaller (or equal) than W3 and for which the URL value of the directly succeeding index mark is greater (or equal) than W3")," is selected because it means that granule 1 can possibly contain rows with URL W3).")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Index marks 2 and 3 for which the ",(0,r.kt)("strong",{parentName:"p"},"URL value is greater than W3")," can be excluded, since index marks of a primary index store the minimum key column values for each granule and therefore granule 2 and 3 can't possibly contain URL value W3."))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Predecessor key column has high(er) cardinality"),(0,r.kt)("a",{name:"generic-exclusion-search-slow"})),(0,r.kt)("p",null,"When the UserID has high cardinality then it is unlikely that the same UserID value is spread over multiple table rows and granules. This means the URL values for the index marks are not monotonically increasing:"),(0,r.kt)("img",{src:a(68102).Z,class:"image"}),(0,r.kt)("p",null,"As we can see in the diagram above, all shown marks whose URL values are smaller than W3 are getting selected for streaming its associated granule's rows into the ClickHouse engine."),(0,r.kt)("p",null,"This is because whilst all index marks in the diagram fall into scenario 1 described above, they do not satisfy the mentioned exclusion-precondition that ",(0,r.kt)("em",{parentName:"p"},"the two directly succeeding index marks both have the same UserID value as the current mark")," and thus can\u2019t be excluded."),(0,r.kt)("p",null,"For example, consider index mark 0 for which the ",(0,r.kt)("strong",{parentName:"p"},"URL value is smaller than W3 and for which the URL value of the directly succeeding index mark is also smaller than W3"),". This can ",(0,r.kt)("em",{parentName:"p"},"not")," be excluded because the two directly succeeding index marks 1 and 2 do ",(0,r.kt)("em",{parentName:"p"},"not")," have the same UserID value as the current mark 0."),(0,r.kt)("p",null,"Note the requirement for the two succeeding index marks to have the same UserID value. This ensures that the granules for the current and the next mark are completely composed of U1 UserID values. If only the next mark had the same UserID, the URL value of the next mark could potentially stem from a table row with a different UserID - which is indeed the case when you look at the diagram above i.e. W2 stems from a row with U2 not U1."),(0,r.kt)("p",null,"This ultimately prevents ClickHouse from making assumptions about the maximum URL value in granule 0. Instead it has to assume that granule 0 potentially contains rows with URL value W3 and is forced to select mark 0."),(0,r.kt)("br",null),(0,r.kt)("p",null,"The same scenario is true for mark 1, 2, and 3.")))),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Conclusion")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"The ",(0,r.kt)("a",{href:"https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1444",target:"_blank"},(0,r.kt)("font",{color:"blue"},"generic exclusion search algorithm"))," that ClickHouse is using instead of the ",(0,r.kt)("a",{href:"https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452",target:"_blank"},(0,r.kt)("font",{color:"blue"},"binary search algorithm"))," when a query is filtering on a column that is part of a compound key, but is not the first key column is most effective when the predecessor key column has low(er) cardinality."))),(0,r.kt)("p",null,"In our sample data set both key columns (UserID, URL) have similar high cardinality, and, as explained, the generic exclusion search algorithm is not very effective when the predecessor key column of the URL column has a high(er) or similar cardinality."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note about data skipping index")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Because of the similarly high cardinality of UserID and URL, our ",(0,r.kt)("a",{parentName:"p",href:"#query-on-url"},(0,r.kt)("font",{color:"blue"},"query filtering on URL"))," also wouldn't benefit much from creating a ",(0,r.kt)("a",{parentName:"p",href:"/docs/staging2/docs/guides/improving-query-performance/skipping-indexes"},(0,r.kt)("font",{color:"blue"},"secondary data skipping index"))," on the URL column\nof our ",(0,r.kt)("a",{parentName:"p",href:"#original-table"},(0,r.kt)("font",{color:"blue"},"table with compound primary key (UserID, URL)")),"."),(0,r.kt)("p",{parentName:"div"},"For example this two statements create and populate a ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#primary-keys-and-indexes-in-queries",target:"_blank"},(0,r.kt)("font",{color:"blue"},"minmax"))," data skipping index on the URL column of our table:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER TABLE hits_UserID_URL ADD INDEX url_skipping_index URL TYPE minmax GRANULARITY 4;\nALTER TABLE hits_UserID_URL MATERIALIZE INDEX url_skipping_index;\n")),(0,r.kt)("p",{parentName:"div"},"ClickHouse now created an additional index that is storing - per group of 4 consecutive ",(0,r.kt)("a",{parentName:"p",href:"#granules"},(0,r.kt)("font",{color:"blue"},"granules"))," (note the ",(0,r.kt)("font",{face:"monospace"},"GRANULARITY 4")," clause in the ",(0,r.kt)("font",{face:"monospace"},"ALTER TABLE")," statement above) - the minimum and maximum URL value:"),(0,r.kt)("img",{src:a(37762).Z,class:"image"}),(0,r.kt)("p",{parentName:"div"},"The first index entry (\u2018mark 0\u2019 in the diagram above) is storing the minimum and maximum URL values for the ",(0,r.kt)("a",{parentName:"p",href:"#granules"},(0,r.kt)("font",{color:"blue"},"rows belonging to the first 4 granules of our table")),"."),(0,r.kt)("p",{parentName:"div"},"The second index entry (\u2018mark 1\u2019) is storing the minimum and maximum URL values for the rows belonging to the next 4 granules of our table, and so on."),(0,r.kt)("p",{parentName:"div"},"(ClickHouse also created a special ",(0,r.kt)("a",{parentName:"p",href:"#mark-files"},(0,r.kt)("font",{color:"blue"},"mark file"))," for to the data skipping index for ",(0,r.kt)("a",{parentName:"p",href:"#mark-files"},(0,r.kt)("font",{color:"blue"},"locating"))," the groups of granules associated with the index marks.)"),(0,r.kt)("p",{parentName:"div"},"Because of the similarly high cardinality of UserID and URL, this secondary data skipping index can't help with excluding granules from being selected when our ",(0,r.kt)("a",{parentName:"p",href:"#query-on-url"},(0,r.kt)("font",{color:"blue"},"query filtering on URL"))," is executed."),(0,r.kt)("p",{parentName:"div"},"The specific URL value that the query is looking for (i.e. 'http://public_search') very likely is between the minimum and maximum value stored by the index for each group of granules resulting in ClickHouse being forced to select the group of granules (because they might contain row(s) matching the query). "))),(0,r.kt)("p",null,"As a consequence, if we want to significantly speed up our sample query that filters for rows with a specific URL then we need to use a primary index optimized to that query."),(0,r.kt)("p",null,"If in addition we want to keep the good performance of our sample query that filters for rows with a specific UserID then we need to use multiple primary indexes."),(0,r.kt)("p",null,"The following is showing ways for achieving that."),(0,r.kt)("h2",{id:"performance-tuning-with-multiple-primary-indexes"},(0,r.kt)("a",{name:"multiple-primary-indexes"}),"Performance tuning with multiple primary indexes"),(0,r.kt)("p",null,"If we want to significantly speed up both of our sample queries - the one that  filters for rows with a specific UserID and the one that filters for rows with a specific URL - then we need to use multiple primary indexes by using one if these three options:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Creating a ",(0,r.kt)("strong",{parentName:"li"},"second table")," with a different primary key."),(0,r.kt)("li",{parentName:"ul"},"Creating a ",(0,r.kt)("strong",{parentName:"li"},"materialized view")," on our existing table."),(0,r.kt)("li",{parentName:"ul"},"Adding a ",(0,r.kt)("strong",{parentName:"li"},"projection")," to our existing table.")),(0,r.kt)("p",null,"All three options will effectively duplicate our sample data into a additional table in order to reorganize the table primary index and row sort order. "),(0,r.kt)("p",null,"However, the three options differ in how transparent that additional table is to the user with respect to the routing of queries and insert statements."),(0,r.kt)("p",null,"When creating a ",(0,r.kt)("strong",{parentName:"p"},"second table")," with a different primary key then queries must be explicitly send to the table version best suited for the query, and new data must be inserted explicitly into both tables in order to keep the tables in sync:"),(0,r.kt)("img",{src:a(24254).Z,class:"image"}),(0,r.kt)("p",null,"With a ",(0,r.kt)("strong",{parentName:"p"},"materialized view")," the additional table is hidden and data is automatically kept in sync between both tables:"),(0,r.kt)("img",{src:a(21794).Z,class:"image"}),(0,r.kt)("p",null,"And the ",(0,r.kt)("strong",{parentName:"p"},"projection")," is the most transparent option because next to automatically keeping the hidden additional table in sync with data changes, ClickHouse will automatically chose the most effective table version for queries:"),(0,r.kt)("img",{src:a(40857).Z,class:"image"}),(0,r.kt)("p",null,"In the following we discuss this three options for creating and using multiple primary indexes in more detail and with real examples."),(0,r.kt)("h2",{id:"multiple-primary-indexes-via-secondary-tables"},(0,r.kt)("a",{name:"multiple-primary-indexes-via-secondary-tables"}),"Multiple primary indexes via secondary tables"),(0,r.kt)("a",{name:"secondary-table"}),"We are creating a new additional table where we switch the order of the key columns (compared to our original table) in the primary key:",(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE hits_URL_UserID\n(\n    `UserID` UInt32,\n    `URL` String,\n    `EventTime` DateTime\n)\nENGINE = MergeTree\n// highlight-next-line  \nPRIMARY KEY (URL, UserID)\nORDER BY (URL, UserID, EventTime)\nSETTINGS index_granularity = 8192, index_granularity_bytes = 0;\n")),(0,r.kt)("p",null,"Insert all 8.87 million rows from our ",(0,r.kt)("a",{parentName:"p",href:"#original-table"},"original table")," into the additional table:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO hits_URL_UserID \nSELECT * from hits_UserID_URL;\n")),(0,r.kt)("p",null,"The response looks like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"Ok.\n\n0 rows in set. Elapsed: 2.898 sec. Processed 8.87 million rows, 838.84 MB (3.06 million rows/s., 289.46 MB/s.)\n")),(0,r.kt)("p",null,"And finally optimize the table:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"OPTIMIZE TABLE hits_URL_UserID FINAL;\n")),(0,r.kt)("p",null,"Because we switched the order of the columns in the primary key, the inserted rows are now stored on disk in a different lexicographical order (compared to our ",(0,r.kt)("a",{parentName:"p",href:"#original-table"},"original table"),") and therefore also the 1083 granules of that table are containing different values than before:"),(0,r.kt)("img",{src:a(19176).Z,class:"image"}),(0,r.kt)("p",null,"This is the resulting primary key:"),(0,r.kt)("img",{src:a(46598).Z,class:"image"}),(0,r.kt)("p",null,'That can now be used to significantly speed up the execution of our example query filtering on the URL column in order to calculate the top 10 users that most frequently clicked on the URL "http://public_search":'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT UserID, count(UserID) AS Count\n// highlight-next-line\nFROM hits_URL_UserID\nWHERE URL = 'http://public_search'\nGROUP BY UserID\nORDER BY Count DESC\nLIMIT 10;\n")),(0,r.kt)("p",null,"The response is:"),(0,r.kt)("a",{name:"query-on-url-fast"}),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500\u2500\u2500\u2500\u2500UserID\u2500\u252c\u2500Count\u2500\u2510\n\u2502 2459550954 \u2502  3741 \u2502\n\u2502 1084649151 \u2502  2484 \u2502\n\u2502  723361875 \u2502   729 \u2502\n\u2502 3087145896 \u2502   695 \u2502\n\u2502 2754931092 \u2502   672 \u2502\n\u2502 1509037307 \u2502   582 \u2502\n\u2502 3085460200 \u2502   573 \u2502\n\u2502 2454360090 \u2502   556 \u2502\n\u2502 3884990840 \u2502   539 \u2502\n\u2502  765730816 \u2502   536 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n10 rows in set. Elapsed: 0.017 sec.\n// highlight-next-line \nProcessed 319.49 thousand rows, \n11.38 MB (18.41 million rows/s., 655.75 MB/s.)\n")),(0,r.kt)("p",null,"Now, instead of ",(0,r.kt)("a",{parentName:"p",href:"#filtering-on-key-columns-after-the-first"},"almost doing a full table scan"),", ClickHouse executed that query much more effective."),(0,r.kt)("p",null,"With the primary index from the ",(0,r.kt)("a",{parentName:"p",href:"#original-table"},"original table")," where UserID was the first, and URL the second key column, ClickHouse used a ",(0,r.kt)("a",{parentName:"p",href:"#generic-exclusion-search-algorithm"},"generic exclusion search")," over the index marks for executing that query and that was not very effective because of the similarly high cardinality of UserID and URL."),(0,r.kt)("p",null,"With URL as the first column in the primary index, ClickHouse is now running ",(0,r.kt)("a",{href:"https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452",target:"_blank"},"binary search")," over the index marks.\nThe corresponding trace log in the ClickHouse server log file confirms that:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"...Executor): Key condition: (column 0 in ['http://public_search', \n                                           'http://public_search'])\n// highlight-next-line                                           \n...Executor): Running binary search on index range for part all_1_9_2 (1083 marks)\n...Executor): Found (LEFT) boundary mark: 644\n...Executor): Found (RIGHT) boundary mark: 683\n...Executor): Found continuous range in 19 steps\n...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,\n// highlight-next-line \n              39/1083 marks by primary key, 39 marks to read from 1 ranges\n...Executor): Reading approx. 319488 rows with 2 streams\n")),(0,r.kt)("p",null,"ClickHouse selected only 39 index marks, instead of 1076 when generic exclusion search was used."),(0,r.kt)("p",null,"Note that the additional table is optimized for speeding up the execution of our example query filtering on URLs."),(0,r.kt)("p",null,"Similar to the ",(0,r.kt)("a",{parentName:"p",href:"#query-on-url-slow"},"bad performance")," of that query with our ",(0,r.kt)("a",{parentName:"p",href:"#original-table"},"original table"),", our ",(0,r.kt)("a",{parentName:"p",href:"#query-on-userid"},"example query filtering on UserIDs")," will not run very effectively with the new additional table, because UserID is now the second key column in the primary index of that table and therefore ClickHouse will use generic exclusion search for granule selection, which is ",(0,r.kt)("a",{parentName:"p",href:"#generic-exclusion-search-slow"},"not very effective for similarly high cardinality")," of UserID and URL.\nOpen the details box for specifics."),(0,r.kt)("details",null,(0,r.kt)("summary",null,(0,r.kt)("font",{color:"black"},"Query filtering on UserIDs now has bad performance",(0,r.kt)("a",{name:"query-on-userid-slow"}))),(0,r.kt)("p",null,(0,r.kt)("font",{color:"black"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT URL, count(URL) AS Count\nFROM hits_URL_UserID\nWHERE UserID = 749927693\nGROUP BY URL\nORDER BY Count DESC\nLIMIT 10;\n")),(0,r.kt)("p",null,"The response is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500URL\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500Count\u2500\u2510\n\u2502 http://auto.ru/chatay-barana.. \u2502   170 \u2502\n\u2502 http://auto.ru/chatay-id=371...\u2502    52 \u2502\n\u2502 http://public_search           \u2502    45 \u2502\n\u2502 http://kovrik-medvedevushku-...\u2502    36 \u2502\n\u2502 http://forumal                 \u2502    33 \u2502\n\u2502 http://korablitz.ru/L_1OFFER...\u2502    14 \u2502\n\u2502 http://auto.ru/chatay-id=371...\u2502    14 \u2502\n\u2502 http://auto.ru/chatay-john-D...\u2502    13 \u2502\n\u2502 http://auto.ru/chatay-john-D...\u2502    10 \u2502\n\u2502 http://wot/html?page/23600_m...\u2502     9 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n10 rows in set. Elapsed: 0.024 sec.\n// highlight-next-line  \nProcessed 8.02 million rows, \n73.04 MB (340.26 million rows/s., 3.10 GB/s.)\n")),(0,r.kt)("p",null,"Server Log:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"...Executor): Key condition: (column 1 in [749927693, 749927693])\n// highlight-next-line\n...Executor): Used generic exclusion search over index for part all_1_9_2 \n              with 1453 steps\n...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,\n// highlight-next-line \n              980/1083 marks by primary key, 980 marks to read from 23 ranges\n...Executor): Reading approx. 8028160 rows with 10 streams\n"))))),(0,r.kt)("p",null,"We now have two tables. Optimized for speeding up queries filtering on UserIDs, and speeding up queries filtering on URLs, respectively:"),(0,r.kt)("img",{src:a(20380).Z,class:"image"}),(0,r.kt)("h2",{id:"multiple-primary-indexes-via-materialized-views"},"Multiple primary indexes via materialized views"),(0,r.kt)("p",null,"Create a ",(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/sql-reference/statements/create/view/#materialized",target:"_blank"},"materialized view")," on our existing table."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv_hits_URL_UserID\nENGINE = MergeTree()\nPRIMARY KEY (URL, UserID)\nORDER BY (URL, UserID, EventTime)\nPOPULATE\nAS SELECT * FROM hits_UserID_URL;\n")),(0,r.kt)("p",null,"The response looks like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"Ok.\n\n0 rows in set. Elapsed: 2.935 sec. Processed 8.87 million rows, 838.84 MB (3.02 million rows/s., 285.84 MB/s.)\n")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("ul",{parentName:"div"},(0,r.kt)("li",{parentName:"ul"},"we switch the order of the key columns (compared to our ",(0,r.kt)("a",{parentName:"li",href:"#original-table"},(0,r.kt)("font",{color:"blue"},"original table"))," ) in the view's primary key"),(0,r.kt)("li",{parentName:"ul"},"the materialzed view is backed by a ",(0,r.kt)("strong",{parentName:"li"},"hidden table")," whose row order and primary index is based on the given primary key definition"),(0,r.kt)("li",{parentName:"ul"},"we use the ",(0,r.kt)("font",{face:"monospace"},"POPULATE")," keyword in order to immediately populate the hidden table with all 8.87 million rows from the source table ",(0,r.kt)("a",{parentName:"li",href:"#original-table"},(0,r.kt)("font",{color:"blue"},"hits_UserID_URL"))," "),(0,r.kt)("li",{parentName:"ul"},"if new rows are inserted into the source table hits_UserID_URL, then that rows are automatically also inserted into the hidden table "),(0,r.kt)("li",{parentName:"ul"},"Effectively the implicitly created hidden table has the same row order and primary index as the ",(0,r.kt)("a",{parentName:"li",href:"#multiple-primary-indexes-via-secondary-tables"},(0,r.kt)("font",{color:"blue"},"secondary table that we created explicitly")),":")),(0,r.kt)("img",{src:a(10281).Z,class:"image"}),(0,r.kt)("p",{parentName:"div"},"ClickHouse is storing the ",(0,r.kt)("a",{parentName:"p",href:"#data-storage"},(0,r.kt)("font",{color:"blue"},"column data files"))," (",(0,r.kt)("em",{parentName:"p"},".bin), the ",(0,r.kt)("a",{parentName:"em",href:"#mark-files"},(0,r.kt)("font",{color:"blue"},"mark files"))," ("),".mrk2) and the ",(0,r.kt)("a",{parentName:"p",href:"#primary-index"},(0,r.kt)("font",{color:"blue"},"primary index"))," (primary.idx) of the hidden table in a special folder withing the ClickHouse server's data directory:"),(0,r.kt)("img",{src:a(86453).Z,class:"image"}))),(0,r.kt)("p",null,"The hidden table (and it's primary index) backing the materialized view can now be used to significantly speed up the execution of our example query filtering on the URL column:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT UserID, count(UserID) AS Count\n// highlight-next-line\nFROM mv_hits_URL_UserID\nWHERE URL = 'http://public_search'\nGROUP BY UserID\nORDER BY Count DESC\nLIMIT 10;\n")),(0,r.kt)("p",null,"The response is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500\u2500\u2500\u2500\u2500UserID\u2500\u252c\u2500Count\u2500\u2510\n\u2502 2459550954 \u2502  3741 \u2502\n\u2502 1084649151 \u2502  2484 \u2502\n\u2502  723361875 \u2502   729 \u2502\n\u2502 3087145896 \u2502   695 \u2502\n\u2502 2754931092 \u2502   672 \u2502\n\u2502 1509037307 \u2502   582 \u2502\n\u2502 3085460200 \u2502   573 \u2502\n\u2502 2454360090 \u2502   556 \u2502\n\u2502 3884990840 \u2502   539 \u2502\n\u2502  765730816 \u2502   536 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n10 rows in set. Elapsed: 0.026 sec.\n// highlight-next-line \nProcessed 335.87 thousand rows, \n13.54 MB (12.91 million rows/s., 520.38 MB/s.)\n")),(0,r.kt)("p",null,"Because effectively the hidden table (and it's primary index) backing the materialized view is identical to the ",(0,r.kt)("a",{parentName:"p",href:"#multiple-primary-indexes-via-secondary-tables"},(0,r.kt)("font",{color:"blue"},"secondary table that we created explicitly")),", the query is executed in the same effective way as with the explicitly created table."),(0,r.kt)("p",null,"The corresponding trace log in the ClickHouse server log file confirms that ClickHouse is running binary search over the index marks:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"...Executor): Key condition: (column 0 in ['http://public_search', \n                                           'http://public_search'])\n// highlight-next-line\n...Executor): Running binary search on index range ...\n...\n...Executor): Selected 4/4 parts by partition key, 4 parts by primary key,\n// highlight-next-line \n              41/1083 marks by primary key, 41 marks to read from 4 ranges\n...Executor): Reading approx. 335872 rows with 4 streams\n")),(0,r.kt)("h2",{id:"multiple-primary-indexes-via-projections"},"Multiple primary indexes via projections"),(0,r.kt)("a",{href:"https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#projections",target:"_blank"},"Projections")," are an experimental feature at the moment, therefore we need to tell ClickHouse that we know what we are doing first:",(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SET allow_experimental_projection_optimization = 1;\n")),(0,r.kt)("p",null,"Create a projection on our existing table:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER TABLE hits_UserID_URL\n    ADD PROJECTION prj_url_userid\n    (\n        SELECT *\n        ORDER BY (URL, UserID)\n    );\n")),(0,r.kt)("p",null,"And materialize the projection:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER TABLE hits_UserID_URL\n    MATERIALIZE PROJECTION prj_url_userid;\n")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("ul",{parentName:"div"},(0,r.kt)("li",{parentName:"ul"},"the projection is creating a ",(0,r.kt)("strong",{parentName:"li"},"hidden table")," whose row order and primary index is based on the given ",(0,r.kt)("font",{face:"monospace"},"ORDER BY")," clause of the projection"),(0,r.kt)("li",{parentName:"ul"},"we use the ",(0,r.kt)("font",{face:"monospace"},"MATERIALIZE")," keyword in order to immediately populate the hidden table with all 8.87 million rows from the source table ",(0,r.kt)("a",{parentName:"li",href:"#original-table"},(0,r.kt)("font",{color:"blue"},"hits_UserID_URL"))),(0,r.kt)("li",{parentName:"ul"},"if new rows are inserted into the source table hits_UserID_URL, then that rows are automatically also inserted into the hidden table"),(0,r.kt)("li",{parentName:"ul"},"a query is always (syntactically) targeting the source table hits_UserID_URL, but if the row order and primary index of the hidden table allows a more effective query execution, then that hidden table will be used instead"),(0,r.kt)("li",{parentName:"ul"},"Effectively the implicitly created hidden table has the same row order and primary index as the ",(0,r.kt)("a",{parentName:"li",href:"#multiple-primary-indexes-via-secondary-tables"},(0,r.kt)("font",{color:"blue"},"secondary table that we created explicitly")),":")),(0,r.kt)("img",{src:a(56567).Z,class:"image"}),(0,r.kt)("p",{parentName:"div"},"ClickHouse is storing the ",(0,r.kt)("a",{parentName:"p",href:"#data-storage"},(0,r.kt)("font",{color:"blue"},"column data files"))," (",(0,r.kt)("em",{parentName:"p"},".bin), the ",(0,r.kt)("a",{parentName:"em",href:"#mark-files"},(0,r.kt)("font",{color:"blue"},"mark files"))," ("),".mrk2) and the ",(0,r.kt)("a",{parentName:"p",href:"#primary-index"},(0,r.kt)("font",{color:"blue"},"primary index"))," (primary.idx) of the hidden table in a special folder (marked in orange in the screenshot below) next to the source table's data files, mark files, and primary index files:"),(0,r.kt)("img",{src:a(48692).Z,class:"image"}))),(0,r.kt)("p",null,"The hidden table (and it's primary index) created by the projection can now be (implicitly) used to significantly speed up the execution of our example query filtering on the URL column. Note that the query is syntactically targeting the source table of the projection."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT UserID, count(UserID) AS Count\n// highlight-next-line\nFROM hits_UserID_URL\nWHERE URL = 'http://public_search'\nGROUP BY UserID\nORDER BY Count DESC\nLIMIT 10;\n")),(0,r.kt)("p",null,"The response is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500\u2500\u2500\u2500\u2500UserID\u2500\u252c\u2500Count\u2500\u2510\n\u2502 2459550954 \u2502  3741 \u2502\n\u2502 1084649151 \u2502  2484 \u2502\n\u2502  723361875 \u2502   729 \u2502\n\u2502 3087145896 \u2502   695 \u2502\n\u2502 2754931092 \u2502   672 \u2502\n\u2502 1509037307 \u2502   582 \u2502\n\u2502 3085460200 \u2502   573 \u2502\n\u2502 2454360090 \u2502   556 \u2502\n\u2502 3884990840 \u2502   539 \u2502\n\u2502  765730816 \u2502   536 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n10 rows in set. Elapsed: 0.029 sec. \n// highlight-next-line \nProcessed 319.49 thousand rows, 1\n1.38 MB (11.05 million rows/s., 393.58 MB/s.)\n")),(0,r.kt)("p",null,"Because effectively the hidden table (and it's primary index) created by the projection is identical to the ",(0,r.kt)("a",{parentName:"p",href:"#multiple-primary-indexes-via-secondary-tables"},(0,r.kt)("font",{color:"blue"},"secondary table that we created explicitly")),", the query is executed in the same effective way as with the explicitly created table."),(0,r.kt)("p",null,"The corresponding trace log in the ClickHouse server log file confirms that ClickHouse is running binary search over the index marks:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"...Executor): Key condition: (column 0 in ['http://public_search', \n                                           'http://public_search'])\n// highlight-next-line                                           \n...Executor): Running binary search on index range for part prj_url_userid (1083 marks)\n...Executor): ...\n// highlight-next-line\n...Executor): Choose complete Normal projection prj_url_userid\n...Executor): projection required columns: URL, UserID\n...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,\n// highlight-next-line \n              39/1083 marks by primary key, 39 marks to read from 1 ranges\n...Executor): Reading approx. 319488 rows with 2 streams\n")),(0,r.kt)("h2",{id:"removing-inefficient-key-columns"},"Removing inefficient key columns"),(0,r.kt)("p",null,"The primary index of our ",(0,r.kt)("a",{parentName:"p",href:"#original-table"},"table with compound primary key (UserID, URL)")," was very useful for speeding up a ",(0,r.kt)("a",{parentName:"p",href:"#query-on-userid"},"query filtering on UserID"),". But that index is not providing significant help with speeding up a ",(0,r.kt)("a",{parentName:"p",href:"#query-on-url"},"query filtering on URL"),", despite the URL column being part of the compound primary key."),(0,r.kt)("p",null,"And vice versa:\nThe primary index of our ",(0,r.kt)("a",{parentName:"p",href:"#secondary-table"},"table with compound primary key (URL, UserID)")," was speeding up a ",(0,r.kt)("a",{parentName:"p",href:"#query-on-url"},"query filtering on URL"),", but didn't provide much support for a ",(0,r.kt)("a",{parentName:"p",href:"#query-on-userid"},"query filtering on UserID"),"."),(0,r.kt)("p",null,"Because of the similarly high cardinality of the primary key columns UserID and URL, a query that filters on the second key column ",(0,r.kt)("a",{parentName:"p",href:"#generic-exclusion-search-slow"},"doesn\u2019t benefit much from the second key column being in the index"),"."),(0,r.kt)("p",null,"Therefore it makes sense to remove the second key column from the primary index (resulting in less memory consumption of the index) and to ",(0,r.kt)("a",{parentName:"p",href:"#multiple-primary-indexes"},"use multiple primary indexes")," instead."),(0,r.kt)("p",null,"However if the key columns in a compound primary key have big differences in cardinality, then it is ",(0,r.kt)("a",{parentName:"p",href:"#generic-exclusion-search-fast"},"beneficial for queries")," to order the primary key columns by cardinality in ascending order."),(0,r.kt)("p",null,"The higher the cardinality difference between the key columns is, the more the order of those columns in the key matters. We will demonstrate that in a future article. Stay tuned."))}h.isMDXComponent=!0},48430:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-01-2941706e5275aed3ef7e0ea242196c41.png"},60418:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-02-2b2fa8c54c018fd39db9c8a2939dc12c.png"},90179:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-03a-d89d998e12380419456e8b198110752b.png"},4918:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-03b-a5f733bcca895013c09f3cb54a1b3681.png"},26391:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-04-c2a0808fb08a8371fad3b2dffb11bb5a.png"},60044:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-05-02e2356da8eb292a54513b2f587cfaf6.png"},7205:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-06-224817ee7963fde05014a2ff7c8676d9.png"},16861:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-07-ca969e10017e98b0bbc54d7d12e015ce.png"},68102:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-08-54c7f76e3fb20ebf6b43f39070bc700d.png"},24254:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-09a-003957a1db28ae299e76de115d417152.png"},21794:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-09b-ddff4059f4f713e55562d4ea02b3e2db.png"},40857:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-09c-f119a3e25f91776b8afb3f5c637435e4.png"},19176:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-10-5004790259b0e01501b4d6cb134cf89b.png"},46598:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-11-ab890a1c2452311841344927ae544e05.png"},20380:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-12a-54e3db82bfbb418a37bd38c6b1f404cf.png"},10281:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-12b-1-bf8c8989b70222764d67aa053b32ab36.png"},86453:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-12b-2-f0fe4fee1e1c4e9e46097ecaa4ae0313.png"},56567:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-12c-1-90b8028f1ac3927bec9fc9b0d0763ac9.png"},48692:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-12c-2-197ed8132c0d6c239074af1ea1bb094e.png"},37762:function(e,t,a){t.Z=a.p+"assets/images/sparse-primary-indexes-13a-bb454960e2aee77973232e65468a19a6.png"}}]);